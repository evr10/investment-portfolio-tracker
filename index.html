<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analytics Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap');
        * { font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const STARTING_CASH_BALANCE = 0;

        const normalizeAccountNumber = (accountNum) => {
            if (!accountNum) return '';
            return accountNum.toString().replace(/[-\s]/g, '');
        };

        const isHSAAccount = (accountName) => {
            return accountName && accountName.toUpperCase().includes('HEALTH SAVINGS');
        };

        const calculateCashBalance = (transactions, cutoffDate) => {
            if (!transactions || transactions.length === 0) return STARTING_CASH_BALANCE;
            let balance = STARTING_CASH_BALANCE;
            const cutoff = new Date(cutoffDate);
            transactions.forEach(trans => {
                if (trans.type === 'HSA') return;
                if (!trans.date) return;
                const transDate = new Date(trans.date);
                if (transDate > cutoff) return;
                const amount = trans.amount || 0;
                if (trans.type === 'Cash') balance += amount;
                else if (trans.type === 'Buy' && amount < 0) balance += amount;
                else if (trans.type === 'Sell' && amount > 0) balance += amount;
                else if (trans.type === 'Dividend' && amount > 0) balance += amount;
            });
            return balance;
        };

        const TrendingUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
        const Calendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const Upload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const Download = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const Trash = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const ChevronDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"></polyline></svg>;
        const DollarSign = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>;
        const BarChart3 = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>;
        const PieChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>;
        const ArrowUpRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>;

        // Simple waterfall chart component (no external dependencies)
        const SimpleWaterfall = ({ data, formatCurrency, startValue }) => {
            const maxValue = Math.max(...data.map(d => d.cumulative));
            const minValue = Math.min(...data.map(d => d.start));
            const range = maxValue - minValue;

            return (
                <div className="w-full h-96 flex items-end justify-around gap-2 px-4">
                    {data.map((item, idx) => {
                        const isAnchor = item.type === 'anchor';
                        const height = isAnchor ? ((item.end - minValue) / range) * 100 : (Math.abs(item.value) / range) * 100;
                        const bottom = isAnchor ? 0 : ((item.start - minValue) / range) * 100;

                        return (
                            <div key={idx} className="flex-1 flex flex-col items-center justify-end h-full">
                                <div className="text-xs text-slate-400 mb-2 text-center font-semibold">
                                    {formatCurrency(item.value)}
                                </div>
                                <div className="relative w-full" style={{ height: '80%' }}>
                                    <div 
                                        className="absolute w-full rounded-t transition-all hover:opacity-80"
                                        style={{ 
                                            height: `${height}%`,
                                            bottom: `${bottom}%`,
                                            backgroundColor: item.fill
                                        }}
                                    />
                                </div>
                                <div className="text-xs text-slate-300 mt-2 text-center font-medium">
                                    {item.name}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const PortfolioDashboard = () => {
            const [activeTab, setActiveTab] = useState('alltime');
            const [subTab, setSubTab] = useState('byaccount');
            const [showImport, setShowImport] = useState(false);
            const [portfolioData, setPortfolioData] = useState(null);
            const [uploadedFiles, setUploadedFiles] = useState({ '2024': [], '2025': [], 'transactions': [] });
            const [transactionFilter, setTransactionFilter] = useState('All');

            useEffect(() => {
                const saved = localStorage.getItem('portfolioData');
                if (saved) {
                    try { setPortfolioData(JSON.parse(saved)); } 
                    catch (e) { console.error('Failed to parse saved data', e); }
                }
            }, []);

            useEffect(() => {
                if (portfolioData) {
                    localStorage.setItem('portfolioData', JSON.stringify(portfolioData));
                }
            }, [portfolioData]);

            const parseCSV = (file) => {
                return new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => resolve(results.data),
                        error: (error) => reject(error)
                    });
                });
            };

            const processHoldingsCSV = async (file) => {
                const data = await parseCSV(file);
                const accountsByNumber = {};
                const allHoldings = [];
                let totalValue = 0;
                let totalCostBasis = 0;

                data.forEach(row => {
                    const accountNum = normalizeAccountNumber(row.Account_Number);
                    if (!accountNum) return;
                    const marketValue = parseFloat(row.Market_Value) || 0;
                    const costBasis = parseFloat(row.Cost_Basis) || 0;
                    const quantity = parseFloat(row.Quantity) || 0;
                    const price = parseFloat(row.Price) || 0;

                    allHoldings.push({
                        accountNumber: accountNum,
                        assetClass: row.Asset_Class || '',
                        symbol: row.Symbol || '',
                        description: row.Description || '',
                        quantity, price, marketValue, costBasis,
                        unrealizedGainLoss: parseFloat(row.Unrealized_Gain_Loss) || 0
                    });

                    if (!accountsByNumber[accountNum]) {
                        accountsByNumber[accountNum] = { value: 0, costBasis: 0, holdings: 0 };
                    }
                    accountsByNumber[accountNum].value += marketValue;
                    accountsByNumber[accountNum].costBasis += costBasis;
                    accountsByNumber[accountNum].holdings += 1;
                    totalValue += marketValue;
                    totalCostBasis += costBasis;
                });

                return { totalValue, totalCostBasis, accountsByNumber, allHoldings };
            };

            const processTransactionsCSV = async (file) => {
                const data = await parseCSV(file);
                const accountNames = {};
                const accountTransactions = {};
                const allTransactions = [];
                let purchases = 0, sales = 0, dividendsReinvested = 0;

                data.forEach(row => {
                    const accountNum = normalizeAccountNumber(row['Account Number']);
                    const accountName = row.Account || '';
                    const action = (row.Action || '').toUpperCase();
                    const amount = parseFloat(row.Amount) || 0;

                    if (accountNum && accountName && !accountNames[accountNum]) {
                        accountNames[accountNum] = accountName;
                    }

                    let type = 'Other';
                    if (isHSAAccount(accountName)) type = 'HSA';
                    else if (action.includes('MARGIN INTEREST') || action.includes('WIRE TRANSFER') || action.includes('ELECTRONIC FUNDS TRANSFER') || action.includes('FEE')) type = 'Cash';
                    else if (action.includes('CONTRIBUTION')) type = 'Buy';
                    else if (action.includes('REINVESTMENT')) type = 'Reinvestment';
                    else if (action.includes('DIVIDEND')) type = 'Dividend';
                    else if (action.includes('YOU BOUGHT') || (amount < 0 && !action.includes('DIVIDEND') && !action.includes('REINVESTMENT') && !action.includes('WIRE') && !action.includes('DEBIT'))) type = 'Buy';
                    else if (action.includes('YOU SOLD')) type = 'Sell';

                    allTransactions.push({
                        date: row['Run Date'] || '', account: accountName, accountNumber: accountNum,
                        action: row.Action || '', symbol: row.Symbol || '', description: row.Description || '',
                        quantity: parseFloat(row.Quantity) || 0, price: parseFloat(row.Price) || 0,
                        amount: amount, type: type
                    });

                    if (isHSAAccount(accountName) || type === 'Cash') return;

                    if (accountNum && !accountTransactions[accountNum]) {
                        accountTransactions[accountNum] = { purchases: 0, sales: 0, dividendsReinvested: 0, netInvested: 0 };
                    }

                    if (action.includes('CONTRIBUTION')) {
                        const contributionAmount = Math.abs(amount);
                        purchases += contributionAmount;
                        if (accountNum) accountTransactions[accountNum].purchases += contributionAmount;
                    } else if (action.includes('REINVESTMENT')) {
                        const reinvAmount = Math.abs(amount);
                        dividendsReinvested += reinvAmount;
                        if (accountNum) accountTransactions[accountNum].dividendsReinvested += reinvAmount;
                    } else if (action.includes('YOU BOUGHT') || (amount < 0 && !action.includes('DIVIDEND') && !action.includes('REINVESTMENT'))) {
                        const purchaseAmount = Math.abs(amount);
                        purchases += purchaseAmount;
                        if (accountNum) accountTransactions[accountNum].purchases += purchaseAmount;
                    } else if (action.includes('YOU SOLD')) {
                        const saleAmount = Math.abs(amount);
                        sales += saleAmount;
                        if (accountNum) accountTransactions[accountNum].sales += saleAmount;
                    }
                });

                Object.keys(accountTransactions).forEach(accountNum => {
                    const acct = accountTransactions[accountNum];
                    acct.netInvested = acct.purchases + acct.dividendsReinvested - acct.sales;
                });

                return {
                    accountNames, accountTransactions, allTransactions,
                    purchases, sales, dividendsReinvested,
                    netInvested: purchases + dividendsReinvested - sales
                };
            };

            const handleFileUpload = async (event, type) => {
                const files = Array.from(event.target.files);
                if (!files || files.length === 0) return;

                try {
                    for (const file of files) {
                        setUploadedFiles(prev => ({ ...prev, [type]: [...prev[type], file.name] }));

                        if (type === '2024') {
                            const holdings2024 = await processHoldingsCSV(file);
                            setPortfolioData(prev => {
                                const filteredAccounts = {}, filteredHoldings = [];
                                let filteredValue = 0, filteredCostBasis = 0;
                                Object.entries(holdings2024.accountsByNumber).forEach(([accountNum, data]) => {
                                    filteredAccounts[accountNum] = data;
                                    filteredValue += data.value;
                                    filteredCostBasis += data.costBasis;
                                });
                                holdings2024.allHoldings.forEach(holding => filteredHoldings.push(holding));
                                return {
                                    ...prev,
                                    holdings2024: {
                                        totalValue: (prev?.holdings2024?.totalValue || 0) + filteredValue,
                                        totalCostBasis: (prev?.holdings2024?.totalCostBasis || 0) + filteredCostBasis,
                                        accountsByNumber: { ...(prev?.holdings2024?.accountsByNumber || {}), ...filteredAccounts },
                                        allHoldings: [...(prev?.holdings2024?.allHoldings || []), ...filteredHoldings]
                                    }
                                };
                            });
                        } else if (type === '2025') {
                            const holdings2025 = await processHoldingsCSV(file);
                            setPortfolioData(prev => {
                                const filteredAccounts = {}, filteredHoldings = [];
                                let filteredValue = 0, filteredCostBasis = 0;
                                Object.entries(holdings2025.accountsByNumber).forEach(([accountNum, data]) => {
                                    filteredAccounts[accountNum] = data;
                                    filteredValue += data.value;
                                    filteredCostBasis += data.costBasis;
                                });
                                holdings2025.allHoldings.forEach(holding => filteredHoldings.push(holding));
                                return {
                                    ...prev,
                                    holdings2025: {
                                        totalValue: (prev?.holdings2025?.totalValue || 0) + filteredValue,
                                        totalCostBasis: (prev?.holdings2025?.totalCostBasis || 0) + filteredCostBasis,
                                        accountsByNumber: { ...(prev?.holdings2025?.accountsByNumber || {}), ...filteredAccounts },
                                        allHoldings: [...(prev?.holdings2025?.allHoldings || []), ...filteredHoldings]
                                    }
                                };
                            });
                        } else if (type === 'transactions') {
                            const trans = await processTransactionsCSV(file);
                            setPortfolioData(prev => ({
                                ...prev,
                                accountNames: { ...(prev?.accountNames || {}), ...trans.accountNames },
                                accountTransactions: { ...(prev?.accountTransactions || {}), ...trans.accountTransactions },
                                allTransactions: [...(prev?.allTransactions || []), ...trans.allTransactions],
                                transactions2025: {
                                    purchases: (prev?.transactions2025?.purchases || 0) + trans.purchases,
                                    sales: (prev?.transactions2025?.sales || 0) + trans.sales,
                                    dividendsReinvested: (prev?.transactions2025?.dividendsReinvested || 0) + trans.dividendsReinvested,
                                    netInvested: (prev?.transactions2025?.netInvested || 0) + trans.netInvested
                                }
                            }));
                        }
                    }
                    event.target.value = '';
                } catch (error) {
                    alert(`Error processing ${type} files: ${error.message}`);
                }
            };

            const handleExport = () => {
                const dataStr = JSON.stringify(portfolioData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `portfolio-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleClearData = () => {
                if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                    localStorage.removeItem('portfolioData');
                    setPortfolioData(null);
                    setUploadedFiles({ '2024': [], '2025': [], 'transactions': [] });
                }
            };

            const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(value);
            const formatPercent = (value) => `${value >= 0 ? '+' : ''}${value.toFixed(2)}%`;
            const formatNumber = (value) => Math.abs(value) >= 1000 ? (value / 1000).toFixed(1) + 'K' : value.toFixed(0);

            const filteredTransactions = portfolioData?.allTransactions?.filter(trans => {
                if (transactionFilter === 'All') return true;
                return trans.type === transactionFilter;
            }) || [];

            const getNonHSAAccounts = (accountsByNumber) => {
                if (!accountsByNumber) return {};
                const filtered = {};
                Object.entries(accountsByNumber).forEach(([accountNum, data]) => {
                    const accountName = portfolioData?.accountNames?.[accountNum];
                    if (!isHSAAccount(accountName)) filtered[accountNum] = data;
                });
                return filtered;
            };

            const getNonHSAHoldings = (allHoldings) => {
                if (!allHoldings) return [];
                return allHoldings.filter(holding => {
                    const accountName = portfolioData?.accountNames?.[holding.accountNumber];
                    return !isHSAAccount(accountName);
                });
            };

            const cashBalance2024 = calculateCashBalance(portfolioData?.allTransactions, '2024-12-31');
            const cashBalance2025 = calculateCashBalance(portfolioData?.allTransactions, '2025-12-31');

            const nonHSAHoldings2025 = getNonHSAHoldings(portfolioData?.holdings2025?.allHoldings);
            const stocksValue2025 = nonHSAHoldings2025.reduce((sum, h) => sum + h.marketValue, 0);
            const currentValue = stocksValue2025 + cashBalance2025;
            const costBasis = nonHSAHoldings2025.reduce((sum, h) => sum + h.costBasis, 0);
            const unrealizedGain = currentValue - costBasis;
            const unrealizedGainPct = costBasis > 0 ? (unrealizedGain / costBasis) * 100 : 0;

            const nonHSAHoldings2024 = getNonHSAHoldings(portfolioData?.holdings2024?.allHoldings);
            const stocksValue2024 = nonHSAHoldings2024.reduce((sum, h) => sum + h.marketValue, 0);
            const startValue = stocksValue2024 + cashBalance2024;
            const endValue = currentValue;
            const netInflows = portfolioData?.transactions2025?.netInvested || 0;
            const marketGain = endValue - (startValue + netInflows);
            const marketGainPct = (startValue + netInflows) > 0 ? (marketGain / (startValue + netInflows)) * 100 : 0;
            const totalChange = endValue - startValue;
            const totalChangePct = startValue > 0 ? (totalChange / startValue) * 100 : 0;

            const hasData = portfolioData && portfolioData.holdings2025;

            const nonHSAAccounts2025 = getNonHSAAccounts(portfolioData?.holdings2025?.accountsByNumber);
            const nonHSAAccounts2024 = getNonHSAAccounts(portfolioData?.holdings2024?.accountsByNumber);

            const calculateWaterfallData = () => {
                if (!portfolioData?.allTransactions) return [];
                
                const start2024 = startValue;
                const end2025 = endValue;
                
                const cashFlowTransactions = portfolioData.allTransactions.filter(t => 
                    t.type === 'Cash' && t.date && new Date(t.date).getFullYear() === 2025
                );
                const netCashFlow = cashFlowTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                
                const dividendTransactions = portfolioData.allTransactions.filter(t => 
                    t.type === 'Dividend' && t.date && new Date(t.date).getFullYear() === 2025
                );
                const totalDividends = dividendTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                
                const netStockPurchases = -(portfolioData.transactions2025?.purchases || 0) + (portfolioData.transactions2025?.sales || 0);
                const marketAppreciation = end2025 - (start2024 + netCashFlow + totalDividends + netStockPurchases);
                
                let cumulative = 0;
                const data = [];
                
                data.push({ name: '2024 Start', value: start2024, start: 0, end: start2024, cumulative: start2024, type: 'anchor', fill: '#3b82f6' });
                cumulative = start2024;
                
                data.push({ name: 'Net Cash Flow', value: netCashFlow, start: cumulative, end: cumulative + netCashFlow, cumulative: cumulative + netCashFlow, type: 'step', fill: netCashFlow >= 0 ? '#10b981' : '#ef4444' });
                cumulative += netCashFlow;
                
                data.push({ name: 'Dividends', value: totalDividends, start: cumulative, end: cumulative + totalDividends, cumulative: cumulative + totalDividends, type: 'step', fill: totalDividends >= 0 ? '#10b981' : '#ef4444' });
                cumulative += totalDividends;
                
                data.push({ name: 'Net Purchases', value: netStockPurchases, start: cumulative, end: cumulative + netStockPurchases, cumulative: cumulative + netStockPurchases, type: 'step', fill: netStockPurchases >= 0 ? '#10b981' : '#ef4444' });
                cumulative += netStockPurchases;
                
                data.push({ name: 'Market Gain', value: marketAppreciation, start: cumulative, end: cumulative + marketAppreciation, cumulative: cumulative + marketAppreciation, type: 'step', fill: marketAppreciation >= 0 ? '#10b981' : '#ef4444' });
                cumulative += marketAppreciation;
                
                data.push({ name: '2025 End', value: end2025, start: 0, end: end2025, cumulative: end2025, type: 'anchor', fill: '#3b82f6' });
                
                return data;
            };

            const waterfallData = calculateWaterfallData();

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100">
                    <div className="border-b border-slate-800 bg-slate-950/50 backdrop-blur-sm sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-8 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-gradient-to-br from-emerald-400 to-cyan-400 rounded-lg flex items-center justify-center">
                                    <span className="text-slate-950 font-bold text-xl">â‚¿</span>
                                </div>
                                <h1 className="text-2xl font-bold">Portfolio Tracker</h1>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="text-xs text-emerald-400 bg-emerald-400/10 px-3 py-1 rounded-full border border-emerald-400/30">
                                    ðŸ”’ LOCAL STORAGE ONLY
                                </span>
                                {hasData && (
                                    <>
                                        <button onClick={handleExport} className="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded-lg transition-all border border-slate-700">
                                            <Download />Export
                                        </button>
                                        <button onClick={handleClearData} className="flex items-center gap-2 px-4 py-2 bg-red-900/20 hover:bg-red-900/30 text-red-400 rounded-lg transition-all border border-red-800/50">
                                            <Trash />Clear Data
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-8">
                        <div className="mb-8">
                            <button onClick={() => setShowImport(!showImport)} className="w-full bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-2xl p-6 hover:border-slate-700 transition-all flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <Upload /><span className="font-semibold text-lg">Import Data</span>
                                </div>
                                <div className={`transform transition-transform ${showImport ? 'rotate-180' : ''}`}><ChevronDown /></div>
                            </button>

                            {showImport && (
                                <div className="mt-4 bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-2xl p-6 space-y-4 animate-fadeIn">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-400 mb-2">
                                                Holdings 2024 CSV
                                                {uploadedFiles['2024'].length > 0 && (
                                                    <span className="ml-2 text-xs text-emerald-400">({uploadedFiles['2024'].length} file{uploadedFiles['2024'].length > 1 ? 's' : ''})</span>
                                                )}
                                            </label>
                                            <input type="file" accept=".csv" multiple onChange={(e) => handleFileUpload(e, '2024')} className="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-emerald-900/20 file:text-emerald-400 hover:file:bg-emerald-900/30 file:cursor-pointer cursor-pointer" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-400 mb-2">
                                                Holdings 2025 CSV
                                                {uploadedFiles['2025'].length > 0 && (
                                                    <span className="ml-2 text-xs text-emerald-400">({uploadedFiles['2025'].length} file{uploadedFiles['2025'].length > 1 ? 's' : ''})</span>
                                                )}
                                            </label>
                                            <input type="file" accept=".csv" multiple onChange={(e) => handleFileUpload(e, '2025')} className="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-emerald-900/20 file:text-emerald-400 hover:file:bg-emerald-900/30 file:cursor-pointer cursor-pointer" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-400 mb-2">
                                                Transactions 2025 CSV
                                                {uploadedFiles['transactions'].length > 0 && (
                                                    <span className="ml-2 text-xs text-emerald-400">({uploadedFiles['transactions'].length} file{uploadedFiles['transactions'].length > 1 ? 's' : ''})</span>
                                                )}
                                            </label>
                                            <input type="file" accept=".csv" multiple onChange={(e) => handleFileUpload(e, 'transactions')} className="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-emerald-900/20 file:text-emerald-400 hover:file:bg-emerald-900/30 file:cursor-pointer cursor-pointer" />
                                        </div>
                                    </div>
                                    <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                                        <div className="text-sm text-slate-400 mb-2">
                                            <span className="font-semibold text-slate-300">Cash/Margin Balance Tracking:</span> Starting balance is set to <span className="text-cyan-400 font-mono">{formatCurrency(STARTING_CASH_BALANCE)}</span>
                                        </div>
                                        <div className="text-xs text-slate-500">
                                            "Cash" type includes: margin interest, wire transfers, electronic funds transfers. To change starting balance: Edit <code className="bg-slate-900 px-2 py-1 rounded text-cyan-400">STARTING_CASH_BALANCE</code> at the top of the code.
                                        </div>
                                    </div>
                                    <p className="text-xs text-slate-500">
                                        Select one or multiple CSV files. <span className="text-amber-400">HSA accounts excluded from calculations.</span> Cash balance tracks all deposits, withdrawals, and margin interest automatically.
                                    </p>
                                </div>
                            )}
                        </div>

                        {!hasData ? (
                            <div className="text-center py-20">
                                <div className="text-6xl mb-4">ðŸ“Š</div>
                                <h2 className="text-2xl font-bold mb-2 text-slate-300">No Data Yet</h2>
                                <p className="text-slate-500">Upload your CSV files to get started</p>
                            </div>
                        ) : (
                            <>
                                <div className="mb-6 bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <div className="text-xs text-slate-500 mb-1">CALCULATED CASH/MARGIN BALANCE</div>
                                            <div className="flex items-center gap-4">
                                                <div>
                                                    <span className="text-xs text-slate-400">2024: </span>
                                                    <span className={`font-semibold ${cashBalance2024 >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                        {formatCurrency(cashBalance2024)}
                                                    </span>
                                                </div>
                                                <div>
                                                    <span className="text-xs text-slate-400">2025: </span>
                                                    <span className={`font-semibold ${cashBalance2025 >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                        {formatCurrency(cashBalance2025)}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-xs text-slate-500">
                                                {cashBalance2025 >= 0 ? 'ðŸ’° Cash Position' : 'ðŸ“Š Margin Loan'}
                                            </div>
                                            <div className="text-xs text-slate-600 mt-1">Incl. deposits, withdrawals, interest</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-4 mb-8 border-b border-slate-800 pb-1">
                                    <button onClick={() => setActiveTab('alltime')} className={`px-6 py-3 font-semibold text-lg transition-all duration-300 relative ${activeTab === 'alltime' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}>
                                        <span className="inline-flex items-center gap-2"><TrendingUp />All-Time Performance</span>
                                        {activeTab === 'alltime' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-400 to-cyan-400 rounded-full" />}
                                    </button>
                                    <button onClick={() => setActiveTab('2025')} className={`px-6 py-3 font-semibold text-lg transition-all duration-300 relative ${activeTab === '2025' ? 'text-cyan-400' : 'text-slate-500 hover:text-slate-300'}`}>
                                        <span className="inline-flex items-center gap-2"><Calendar />2025 Year-in-Review</span>
                                        {activeTab === '2025' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-cyan-400 to-blue-400 rounded-full" />}
                                    </button>
                                </div>

                                {activeTab === 'alltime' && (
                                    <div className="space-y-6 animate-fadeIn">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-2xl p-6 hover:border-emerald-500/50 transition-all duration-300">
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="text-slate-400 text-sm font-medium">Total Portfolio Value</span><DollarSign />
                                                </div>
                                                <div className="text-3xl font-bold text-emerald-400">{formatCurrency(currentValue)}</div>
                                                <div className="text-xs text-slate-500 mt-1">
                                                    Stocks: {formatCurrency(stocksValue2025)} | Cash: {formatCurrency(cashBalance2025)}
                                                </div>
                                            </div>
                                            <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-2xl p-6 hover:border-blue-500/50 transition-all duration-300">
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="text-slate-400 text-sm font-medium">Total Cost Basis</span><BarChart3 />
                                                </div>
                                                <div className="text-3xl font-bold text-blue-400">{formatCurrency(costBasis)}</div>
                                                <div className="text-xs text-slate-500 mt-1">Stocks only (excl. HSA)</div>
                                            </div>
                                            <div className="bg-gradient-to-br from-emerald-900/30 to-cyan-900/30 backdrop-blur-sm border border-emerald-500/50 rounded-2xl p-6 shadow-lg shadow-emerald-500/20">
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="text-slate-300 text-sm font-medium">Lifetime Unrealized Gain</span><ArrowUpRight />
                                                </div>
                                                <div className="text-3xl font-bold text-emerald-400">{formatCurrency(unrealizedGain)}</div>
                                                <div className="text-sm text-emerald-400 mt-2 font-semibold">{formatPercent(unrealizedGainPct)}</div>
                                            </div>
                                        </div>

                                        <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-2xl p-8">
                                            <h2 className="text-2xl font-bold mb-6 flex items-center gap-3">
                                                <PieChart />Holdings Breakdown
                                                <span className="text-xs text-slate-500 font-normal">(HSA excluded)</span>
                                            </h2>
                                            <div className="space-y-4">
                                                {Math.abs(cashBalance2025) > 100 && (
                                                    <div className="bg-slate-800/50 rounded-xl p-5 border border-slate-700 hover:border-slate-600 transition-all">
                                                        <div className="flex justify-between items-start mb-3">
                                                            <div>
                                                                <h3 className="font-semibold text-lg text-slate-200">
                                                                    {cashBalance2025 >= 0 ? 'ðŸ’µ Cash Balance' : 'ðŸ“Š Margin Loan'}
                                                                </h3>
                                                                <p className="text-sm text-slate-500">Deposits, withdrawals, interest</p>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className={`text-xl font-bold ${cashBalance2025 >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                                    {formatCurrency(Math.abs(cashBalance2025))}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="relative h-2 bg-slate-700/50 rounded-full overflow-hidden">
                                                            <div className={`absolute h-full rounded-full transition-all duration-500 ${cashBalance2025 >= 0 ? 'bg-gradient-to-r from-emerald-400 to-cyan-400' : 'bg-gradient-to-r from-red-500 to-orange-500'}`} style={{ width: `${Math.min(Math.abs(cashBalance2025) / Math.abs(currentValue) * 100, 100)}%` }} />
                                                        </div>
                                                        <div className="text-xs text-slate-500 mt-2">
                                                            {cashBalance2025 >= 0 
                                                                ? `${(cashBalance2025 / currentValue * 100).toFixed(1)}% of portfolio`
                                                                : `Leveraged position`
                                                            }
                                                        </div>
                                                    </div>
                                                )}

                                                {Object.entries(nonHSAAccounts2025).map(([accountNum, account]) => {
                                                    const accountName = portfolioData.accountNames?.[accountNum] || accountNum;
                                                    const accountGain = account.value - account.costBasis;
                                                    const accountGainPct = account.costBasis > 0 ? (accountGain / account.costBasis) * 100 : 0;
                                                    const percentage = stocksValue2025 > 0 ? (account.value / stocksValue2025) * 100 : 0;
                                                    if (account.value === 0) return null;

                                                    return (
                                                        <div key={accountNum} className="bg-slate-800/50 rounded-xl p-5 border border-slate-700 hover:border-slate-600 transition-all">
                                                            <div className="flex justify-between items-start mb-3">
                                                                <div>
                                                                    <h3 className="font-semibold text-lg text-slate-200">{accountName}</h3>
                                                                    <p className="text-sm text-slate-500">{account.holdings} holdings Â· {accountNum}</p>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="text-xl font-bold text-slate-100">{formatCurrency(account.value)}</div>
                                                                    <div className={`text-sm font-semibold ${accountGain >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                                        {formatCurrency(accountGain)} ({formatPercent(accountGainPct)})
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="relative h-2 bg-slate-700/50 rounded-full overflow-hidden">
                                                                <div className="absolute h-full bg-gradient-to-r from-emerald-400 to-cyan-400 rounded-full transition-all duration-500" style={{ width: `${percentage}%` }} />
                                                            </div>
                                                            <div className="text-xs text-slate-500 mt-2">{percentage.toFixed(1)}% of stock holdings</div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === '2025' && (
                                    <div className="space-y-6 animate-fadeIn">
                                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                                            <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-4">
                                                <div className="text-slate-400 text-xs font-medium mb-1">TOTAL PORTFOLIO VALUE</div>
                                                <div className="text-xl font-bold text-slate-200">{formatCurrency(endValue)}</div>
                                                <div className="text-xs text-emerald-400 mt-1">â–² {formatPercent(totalChangePct)} vs 2024</div>
                                            </div>
                                            <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-4">
                                                <div className="text-slate-400 text-xs font-medium mb-1">2024 STARTING VALUE</div>
                                                <div className="text-xl font-bold text-slate-200">{formatCurrency(startValue)}</div>
                                                <div className="text-xs text-slate-500 mt-1">Stocks + Cash</div>
                                            </div>
                                            <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-4">
                                                <div className="text-slate-400 text-xs font-medium mb-1">NET INVESTED '25</div>
                                                <div className="text-xl font-bold text-slate-200">{formatCurrency(netInflows)}</div>
                                                <div className="text-xs text-slate-500">Buys + Reinv - Sells</div>
                                            </div>
                                            <div className="bg-gradient-to-br from-emerald-900/30 to-cyan-900/30 backdrop-blur-sm border border-emerald-500/50 rounded-xl p-4 shadow-lg shadow-emerald-500/20">
                                                <div className="text-slate-300 text-xs font-medium mb-1">TRUE MARKET GAIN</div>
                                                <div className="text-xl font-bold text-emerald-400">{formatCurrency(marketGain)}</div>
                                                <div className="text-xs text-emerald-400 font-semibold">ROIC: {formatPercent(marketGainPct)}</div>
                                            </div>
                                            <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-4">
                                                <div className="text-slate-400 text-xs font-medium mb-1">2025 PURCHASES</div>
                                                <div className="text-xl font-bold text-slate-200">{formatCurrency(portfolioData.transactions2025?.purchases || 0)}</div>
                                            </div>
                                            <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-4">
                                                <div className="text-slate-400 text-xs font-medium mb-1">2025 SALES</div>
                                                <div className="text-xl font-bold text-slate-200">{formatCurrency(portfolioData.transactions2025?.sales || 0)}</div>
                                            </div>
                                            <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-4">
                                                <div className="text-slate-400 text-xs font-medium mb-1">DIVIDENDS REINVESTED</div>
                                                <div className="text-xl font-bold text-slate-200">{formatCurrency(portfolioData.transactions2025?.dividendsReinvested || 0)}</div>
                                            </div>
                                        </div>

                                        <div className="flex gap-2 bg-slate-900/50 p-2 rounded-xl border border-slate-800">
                                            <button onClick={() => setSubTab('performance')} className={`px-4 py-2 rounded-lg font-medium transition-all ${subTab === 'performance' ? 'bg-slate-800 text-slate-100' : 'text-slate-400 hover:text-slate-200'}`}>
                                                Performance Bridge
                                            </button>
                                            <button onClick={() => setSubTab('byaccount')} className={`px-4 py-2 rounded-lg font-medium transition-all ${subTab === 'byaccount' ? 'bg-slate-800 text-slate-100' : 'text-slate-400 hover:text-slate-200'}`}>
                                                By Account
                                            </button>
                                            <button onClick={() => setSubTab('allholdings')} className={`px-4 py-2 rounded-lg font-medium transition-all ${subTab === 'allholdings' ? 'bg-slate-800 text-slate-100' : 'text-slate-400 hover:text-slate-200'}`}>
                                                All Holdings
                                            </button>
                                            <button onClick={() => setSubTab('transactions')} className={`px-4 py-2 rounded-lg font-medium transition-all ${subTab === 'transactions' ? 'bg-slate-800 text-slate-100' : 'text-slate-400 hover:text-slate-200'}`}>
                                                Transactions
                                            </button>
                                        </div>

                                        {subTab === 'performance' && (
                                            <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-2xl p-8 animate-fadeIn">
                                                <h2 className="text-xl font-bold mb-6">
                                                    2025 Performance Bridge
                                                    <span className="text-xs text-slate-500 font-normal ml-2">How did we get from 2024 to 2025?</span>
                                                </h2>
                                                
                                                <div className="grid grid-cols-4 gap-4 mb-8">
                                                    {waterfallData.filter(d => d.type === 'step').map((step, idx) => (
                                                        <div key={idx} className="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                                                            <div className="text-xs text-slate-400 mb-1">{step.name.toUpperCase()}</div>
                                                            <div className={`text-xl font-bold ${step.value >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                                {formatCurrency(step.value)}
                                                            </div>
                                                            <div className="text-xs text-slate-500 mt-1">
                                                                {step.value >= 0 ? 'â–²' : 'â–¼'} {Math.abs((step.value / startValue) * 100).toFixed(1)}%
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>

                                                <div className="bg-slate-800/30 rounded-lg p-6 border border-slate-700">
                                                    <SimpleWaterfall data={waterfallData} formatCurrency={formatCurrency} startValue={startValue} />
                                                </div>

                                                <div className="mt-6 bg-slate-800/30 rounded-lg p-4 border border-slate-700">
                                                    <h3 className="text-sm font-semibold text-slate-300 mb-2">ðŸ“Š Understanding the Performance Bridge</h3>
                                                    <div className="text-xs text-slate-400 space-y-1">
                                                        <p>â€¢ <strong>Net Cash Flow:</strong> Deposits, withdrawals, and margin interest (Cash type transactions)</p>
                                                        <p>â€¢ <strong>Dividends:</strong> Cash dividends received (not reinvested)</p>
                                                        <p>â€¢ <strong>Net Purchases:</strong> Money deployed into stocks (purchases - sales)</p>
                                                        <p>â€¢ <strong>Market Gain:</strong> Portfolio appreciation from price changes</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<PortfolioDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
