 => !search || h.symbol.toLowerCase().includes(search) || h.name.toLowerCase().includes(search) || h.account.toLowerCase().includes(search))
                .sort((a, b) => b.value2025 - a.value2025);

            document.getElementById('holdingsTableBody').innerHTML = holdings.length === 0 
                ? '<tr><td colspan="7" class="empty-state">No holdings data</td></tr>'
                : holdings.map(h => `
                    <tr>
                        <td><div class="symbol">${h.symbol}</div><div class="company-name">${h.name}</div></td>
                        <td>${h.account}</td>
                        <td class="number">${h.quantity.toFixed(3)}</td>
                        <td class="number">${formatCurrency(h.value2024)}</td>
                        <td class="number">${formatCurrency(h.value2025)}</td>
                        <td class="number ${h.change >= 0 ? 'positive' : 'negative'}">${h.change >= 0 ? '+' : ''}${formatCurrency(h.change)}</td>
                        <td class="number ${h.pctChange >= 0 ? 'positive' : 'negative'}">${h.pctChange >= 0 ? '+' : ''}${h.pctChange.toFixed(1)}%</td>
                    </tr>
                `).join('');
        }

        function renderGrowthTable() {
            const holdings = getMergedHoldings()
                .filter(h => h.value2024 > 0 || h.value2025 > 0)
                .sort((a, b) => b.pctChange - a.pctChange);

            document.getElementById('growthTableBody').innerHTML = holdings.length === 0
                ? '<tr><td colspan="6" class="empty-state">No growth data</td></tr>'
                : holdings.map(h => `
                    <tr>
                        <td class="symbol">${h.symbol}</td>
                        <td>${h.account}</td>
                        <td class="number">${formatCurrency(h.value2024)}</td>
                        <td class="number">${formatCurrency(h.value2025)}</td>
                        <td class="number ${h.change >= 0 ? 'positive' : 'negative'}">${h.change >= 0 ? '+' : ''}${formatCurrency(h.change)}</td>
                        <td class="number ${h.pctChange >= 0 ? 'positive' : 'negative'}">${h.pctChange >= 0 ? '+' : ''}${h.pctChange.toFixed(1)}%</td>
                    </tr>
                `).join('');
        }

        function renderTransactionsTable() {
            const search = (document.getElementById('transactionsSearch')?.value || '').toLowerCase();
            const trans = filterByAccount(portfolioData.transactions)
                .filter(t => !search || t.symbol.toLowerCase().includes(search) || t.action.toLowerCase().includes(search) || t.account.toLowerCase().includes(search))
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 300);

            document.getElementById('transactionsTableBody').innerHTML = trans.length === 0
                ? '<tr><td colspan="7" class="empty-state">No transactions</td></tr>'
                : trans.map(t => {
                    const action = t.action.length > 40 ? t.action.slice(0, 40) + '...' : t.action;
                    return `
                        <tr>
                            <td>${t.date}</td>
                            <td>${action}</td>
                            <td class="symbol">${t.symbol || '-'}</td>
                            <td>${t.account}</td>
                            <td class="number">${t.quantity ? t.quantity.toFixed(3) : '-'}</td>
                            <td class="number">${t.price ? formatCurrency(t.price) : '-'}</td>
                            <td class="number ${t.amount >= 0 ? 'positive' : 'negative'}">${formatCurrency(t.amount)}</td>
                        </tr>
                    `;
                }).join('');
        }

        function renderCharts() {
            const holdings = getMergedHoldings().filter(h => h.value2025 > 0);
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1'];

            const top10 = [...holdings].sort((a, b) => b.value2025 - a.value2025).slice(0, 10);
            
            if (charts.allocation) charts.allocation.destroy();
            charts.allocation = new Chart(document.getElementById('allocationChart'), {
                type: 'doughnut',
                data: {
                    labels: top10.map(h => h.symbol),
                    datasets: [{ data: top10.map(h => h.value2025), backgroundColor: colors, borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#94a3b8', padding: 10, font: { size: 11 } } } }
                }
            });

            if (charts.holdingsBar) charts.holdingsBar.destroy();
            charts.holdingsBar = new Chart(document.getElementById('holdingsBarChart'), {
                type: 'bar',
                data: {
                    labels: top10.map(h => h.symbol),
                    datasets: [{ data: top10.map(h => h.value2025), backgroundColor: colors, borderRadius: 4 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#2d3748' }, ticks: { color: '#94a3b8', callback: v => '$' + (v/1000).toFixed(0) + 'k' } },
                        y: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });

            const withGrowth = holdings.filter(h => h.value2024 > 100).sort((a, b) => b.pctChange - a.pctChange).slice(0, 10);
            
            if (charts.growth) charts.growth.destroy();
            charts.growth = new Chart(document.getElementById('growthChart'), {
                type: 'bar',
                data: {
                    labels: withGrowth.map(h => h.symbol),
                    datasets: [{ data: withGrowth.map(h => h.pctChange), backgroundColor: withGrowth.map(h => h.pctChange >= 0 ? '#10b981' : '#ef4444'), borderRadius: 4 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#2d3748' }, ticks: { color: '#94a3b8', callback: v => v + '%' } },
                        y: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });

            const byDollarGain = [...holdings].sort((a, b) => b.change - a.change).slice(0, 10);
            
            if (charts.dollarGain) charts.dollarGain.destroy();
            charts.dollarGain = new Chart(document.getElementById('dollarGainChart'), {
                type: 'bar',
                data: {
                    labels: byDollarGain.map(h => h.symbol),
                    datasets: [{ data: byDollarGain.map(h => h.change), backgroundColor: byDollarGain.map(h => h.change >= 0 ? '#10b981' : '#ef4444'), borderRadius: 4 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#2d3748' }, ticks: { color: '#94a3b8', callback: v => '$' + (v/1000).toFixed(0) + 'k' } },
                        y: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(`${tab}Tab`).style.display = 'block';
        }

        function formatCurrency(val) {
            if (val == null || isNaN(val)) return '$0';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(val);
        }
    </script>
</body>
</html>
