<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Analytics</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['IBM Plex Sans', 'system-ui', 'sans-serif'],
            mono: ['IBM Plex Mono', 'monospace'],
          },
          colors: {
            accent: { DEFAULT: '#0066FF', light: '#3385FF', dark: '#0052CC' },
            success: { DEFAULT: '#00A870', light: '#00D48F', dark: '#008558' },
            danger: { DEFAULT: '#E5484D', light: '#F27A7D', dark: '#CD2B31' },
            surface: { DEFAULT: '#FAFBFC', dark: '#111827' },
          },
          boxShadow: {
            'card': '0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06)',
            'card-hover': '0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04)',
          }
        }
      }
    }
  </script>
  <style>
    * { -webkit-font-smoothing: antialiased; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeUp { animation: fadeUp 0.3s ease-out forwards; }
    .tabular-nums { font-variant-numeric: tabular-nums; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #4B5563; }
    input[type="file"]::file-selector-button {
      font-family: 'IBM Plex Sans', sans-serif;
      font-weight: 500;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #E5E7EB;
      background: white;
      cursor: pointer;
      transition: all 0.15s;
    }
    input[type="file"]::file-selector-button:hover { background: #F9FAFB; border-color: #D1D5DB; }
    .dark input[type="file"]::file-selector-button { background: #1F2937; border-color: #374151; color: #E5E7EB; }
    .dark input[type="file"]::file-selector-button:hover { background: #374151; }
  </style>
</head>
<body class="bg-surface dark:bg-surface-dark transition-colors">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITY FUNCTIONS - Pure functions for calculations
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const STARTING_CASH = 0;
    const normalize = s => s?.toString().replace(/[-\s]/g, '') || '';
    const isHSA = name => name?.toUpperCase().includes('HEALTH SAVINGS');
    const fmt = {
      currency: v => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v),
      currencyFull: v => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(v),
      percent: v => `${v >= 0 ? '+' : ''}${v.toFixed(2)}%`,
      compact: v => Math.abs(v) >= 1e6 ? `$${(v/1e6).toFixed(1)}M` : Math.abs(v) >= 1e3 ? `$${(v/1e3).toFixed(0)}K` : fmt.currency(v),
    };

    const classifyTransaction = (action, amount, accountName) => {
      if (isHSA(accountName)) return 'HSA';
      const a = action.toUpperCase();
      // ESPP: the journal credit is a duplicate entry, ignore it
      if (/JOURNALED SPP PURCHASE CREDIT/.test(a)) return 'Other';
      if (/MARGIN INTEREST|WIRE TRANSFER|ELECTRONIC FUNDS|FEE/.test(a)) return 'Cash';
      if (/CONTRIBUTION|CONVERSION SHARES DEPOSITED/.test(a)) return 'Buy';
      if (/REINVESTMENT/.test(a)) return 'Reinvestment';
      if (/DIVIDEND|LONG-TERM CAP GAIN|SHORT-TERM CAP GAIN/.test(a)) return 'Dividend';
      if (/YOU BOUGHT/.test(a) || (amount < 0 && !/DIVIDEND|REINVESTMENT|WIRE|DEBIT/.test(a))) return 'Buy';
      if (/YOU SOLD/.test(a)) return 'Sell';
      return 'Other';
    };

    const calcCashBalance = (transactions, cutoff) => {
      if (!transactions?.length) return STARTING_CASH;
      const cutoffDate = new Date(cutoff);
      return transactions.reduce((bal, t) => {
        if (t.type === 'HSA' || !t.date || new Date(t.date) > cutoffDate) return bal;
        const amt = t.amount || 0;
        if (t.type === 'Cash') return bal + amt;
        if (t.type === 'Buy' && amt < 0) return bal + amt;
        if (t.type === 'Sell' && amt > 0) return bal + amt;
        if (t.type === 'Dividend' && amt > 0) return bal + amt;
        return bal;
      }, STARTING_CASH);
    };

    const processHoldings = data => {
      const accounts = {}, holdings = [];
      let totalValue = 0, totalCost = 0;
      data.forEach(r => {
        const num = normalize(r.Account_Number);
        if (!num) return;
        const mv = parseFloat(r.Market_Value) || 0;
        const cb = parseFloat(r.Cost_Basis) || 0;
        holdings.push({
          accountNumber: num, symbol: r.Symbol || '', description: r.Description || '',
          assetClass: r.Asset_Class || '', quantity: parseFloat(r.Quantity) || 0,
          price: parseFloat(r.Price) || 0, marketValue: mv, costBasis: cb,
          gain: parseFloat(r.Unrealized_Gain_Loss) || 0
        });
        accounts[num] = accounts[num] || { value: 0, costBasis: 0, holdings: 0 };
        accounts[num].value += mv;
        accounts[num].costBasis += cb;
        accounts[num].holdings++;
        totalValue += mv;
        totalCost += cb;
      });
      return { totalValue, totalCost, accounts, holdings };
    };

    const processTransactions = data => {
      const names = {}, acctTx = {}, all = [];
      let buys = 0, sells = 0, reinv = 0;
      data.forEach(r => {
        const num = normalize(r['Account Number']);
        const name = r.Account || '';
        const action = r.Action || '';
        const amt = parseFloat(r.Amount) || 0;
        const symbol = r.Symbol || '';
        
        // Skip disclaimer/footer rows (no symbol, no amount, no account)
        if (!symbol && amt === 0 && !num) return;
        // Skip rows that look like disclaimer text (long action text with no real data)
        if (!symbol && amt === 0 && action.length > 50) return;
        
        if (num && name && !names[num]) names[num] = name;
        const type = classifyTransaction(action, amt, name);
        all.push({
          date: r['Run Date'] || '', account: name, accountNumber: num,
          action, symbol: r.Symbol || '', description: r.Description || '',
          quantity: parseFloat(r.Quantity) || 0, price: parseFloat(r.Price) || 0,
          amount: amt, type
        });
        if (isHSA(name) || type === 'Cash') return;
        acctTx[num] = acctTx[num] || { purchases: 0, sales: 0, reinvested: 0 };
        const absAmt = Math.abs(amt);
        if (/CONTRIBUTION|CONVERSION SHARES DEPOSITED/.test(action.toUpperCase())) { buys += absAmt; acctTx[num].purchases += absAmt; }
        else if (/REINVESTMENT/.test(action.toUpperCase())) { reinv += absAmt; acctTx[num].reinvested += absAmt; }
        else if (/YOU BOUGHT/.test(action.toUpperCase()) || (amt < 0 && !/DIVIDEND|REINVESTMENT/.test(action.toUpperCase()))) { buys += absAmt; acctTx[num].purchases += absAmt; }
        else if (/YOU SOLD/.test(action.toUpperCase())) { sells += absAmt; acctTx[num].sales += absAmt; }
      });
      Object.values(acctTx).forEach(a => a.net = a.purchases + a.reinvested - a.sales);
      return { names, acctTx, all, purchases: buys, sales: sells, reinvested: reinv, net: buys + reinv - sells };
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ICONS - Minimal SVG components
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const Icon = ({ d, size = 18, className = '' }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.75" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {Array.isArray(d) ? d.map((p, i) => <path key={i} d={p} />) : <path d={d} />}
      </svg>
    );
    const Icons = {
      chart: () => <Icon d={['M3 3v18h18', 'M18 17V9', 'M13 17V5', 'M8 17v-3']} />,
      calendar: () => <Icon d={['M8 2v4', 'M16 2v4', 'M3 10h18', 'M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z']} />,
      upload: () => <Icon d={['M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4', 'M17 8l-5-5-5 5', 'M12 3v12']} />,
      download: () => <Icon d={['M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4', 'M7 10l5 5 5-5', 'M12 15V3']} />,
      trash: () => <Icon d={['M3 6h18', 'M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2']} />,
      sun: () => <Icon d={['M12 1v2', 'M12 21v2', 'M4.22 4.22l1.42 1.42', 'M18.36 18.36l1.42 1.42', 'M1 12h2', 'M21 12h2', 'M4.22 19.78l1.42-1.42', 'M18.36 5.64l1.42-1.42', 'M12 17a5 5 0 100-10 5 5 0 000 10z']} />,
      moon: () => <Icon d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />,
      chevron: () => <Icon d="M6 9l6 6 6-6" />,
      plus: () => <Icon d={['M12 5v14', 'M5 12h14']} />,
      minus: () => <Icon d="M5 12h14" />,
      arrowUp: () => <Icon d={['M12 19V5', 'M5 12l7-7 7 7']} />,
      arrowDown: () => <Icon d={['M12 5v14', 'M19 12l-7 7-7-7']} />,
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI COMPONENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const Card = ({ children, className = '', hover = false }) => (
      <div className={`bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-card ${hover ? 'hover:shadow-card-hover transition-shadow' : ''} ${className}`}>
        {children}
      </div>
    );

    const Stat = ({ label, value, sub, accent = false, trend }) => (
      <div className={`p-5 ${accent ? 'bg-gradient-to-br from-accent/5 to-accent/10 dark:from-accent/10 dark:to-accent/20 border-accent/20' : ''}`}>
        <div className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">{label}</div>
        <div className={`text-2xl font-semibold tabular-nums ${accent ? 'text-accent' : 'text-gray-900 dark:text-white'}`}>{value}</div>
        {sub && <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">{sub}</div>}
        {trend !== undefined && (
          <div className={`inline-flex items-center gap-1 mt-2 text-sm font-medium ${trend >= 0 ? 'text-success' : 'text-danger'}`}>
            {trend >= 0 ? <Icons.arrowUp /> : <Icons.arrowDown />}
            {fmt.percent(trend)}
          </div>
        )}
      </div>
    );

    const Tabs = ({ tabs, active, onChange }) => (
      <div className="flex border-b border-gray-200 dark:border-gray-700">
        {tabs.map(t => (
          <button key={t.id} onClick={() => onChange(t.id)}
            className={`px-5 py-3 text-sm font-medium transition-colors relative ${active === t.id ? 'text-accent' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}`}>
            <span className="flex items-center gap-2">{t.icon}{t.label}</span>
            {active === t.id && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-accent" />}
          </button>
        ))}
      </div>
    );

    const SubTabs = ({ tabs, active, onChange }) => (
      <div className="flex gap-1 p-1 bg-gray-100 dark:bg-gray-800 rounded-lg w-fit">
        {tabs.map(t => (
          <button key={t} onClick={() => onChange(t)}
            className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${active === t ? 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'}`}>
            {t}
          </button>
        ))}
      </div>
    );

    const Badge = ({ children, variant = 'default' }) => {
      const styles = {
        default: 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300',
        success: 'bg-success/10 text-success',
        danger: 'bg-danger/10 text-danger',
        accent: 'bg-accent/10 text-accent',
      };
      return <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${styles[variant]}`}>{children}</span>;
    };

    const Button = ({ children, onClick, variant = 'default', size = 'md', icon }) => {
      const base = 'inline-flex items-center justify-center gap-2 font-medium rounded-lg transition-all';
      const variants = {
        default: 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700',
        primary: 'bg-accent text-white hover:bg-accent-dark',
        danger: 'bg-danger/10 text-danger hover:bg-danger/20 border border-danger/20',
      };
      const sizes = { sm: 'px-3 py-1.5 text-sm', md: 'px-4 py-2 text-sm' };
      return <button onClick={onClick} className={`${base} ${variants[variant]} ${sizes[size]}`}>{icon}{children}</button>;
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WATERFALL CHART - Clean, readable performance bridge visualization
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const WaterfallChart = ({ data }) => {
      const { min, max, range } = useMemo(() => {
        const vals = data.flatMap(d => [d.start, d.end]);
        const min = Math.min(...vals);
        const max = Math.max(...vals);
        return { min, max, range: max - min };
      }, [data]);

      const toY = v => ((v - min) / range) * 100;

      return (
        <div className="h-80 flex items-end justify-between gap-3 px-2 py-4">
          {data.map((item, i) => {
            const isAnchor = item.type === 'anchor';
            const bottom = toY(Math.min(item.start, item.end));
            const height = Math.abs(toY(item.end) - toY(item.start));
            const isPositive = item.value >= 0;

            return (
              <div key={i} className="flex-1 flex flex-col items-center h-full group">
                <div className="text-xs font-medium tabular-nums mb-2 text-center transition-colors group-hover:text-gray-900 dark:group-hover:text-white text-gray-500 dark:text-gray-400">
                  {item.value >= 0 ? '+' : ''}{fmt.compact(item.value)}
                </div>
                <div className="relative flex-1 w-full">
                  <div 
                    className={`absolute w-full rounded-sm transition-all duration-300 ${isAnchor ? 'bg-accent' : isPositive ? 'bg-success hover:bg-success-dark' : 'bg-danger hover:bg-danger-dark'}`}
                    style={{ bottom: `${bottom}%`, height: `${Math.max(height, 2)}%` }}
                  />
                  {!isAnchor && i > 0 && (
                    <div className="absolute w-full border-t border-dashed border-gray-300 dark:border-gray-600"
                      style={{ bottom: `${toY(item.start)}%` }} />
                  )}
                </div>
                <div className="text-xs text-gray-500 dark:text-gray-400 mt-3 text-center font-medium leading-tight">
                  {item.name}
                </div>
              </div>
            );
          })}
        </div>
      );
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATA TABLE - Reusable table component
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const Table = ({ columns, data, maxHeight = '400px', footer }) => (
      <div className="overflow-auto" style={{ maxHeight }}>
        <table className="w-full text-sm">
          <thead className="sticky top-0 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
            <tr>
              {columns.map((col, i) => (
                <th key={i} className={`px-4 py-3 text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 ${col.align === 'right' ? 'text-right' : 'text-left'}`}>
                  {col.header}
                </th>
              ))}
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
            {data.map((row, i) => (
              <tr key={i} className="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                {columns.map((col, j) => (
                  <td key={j} className={`px-4 py-3 ${col.align === 'right' ? 'text-right tabular-nums' : ''} ${col.mono ? 'font-mono text-xs' : ''}`}>
                    {col.render ? col.render(row[col.key], row) : row[col.key]}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
          {footer && (
            <tfoot className="bg-gray-100 dark:bg-gray-800 border-t-2 border-gray-300 dark:border-gray-600 font-semibold">
              <tr>
                {columns.map((col, i) => (
                  <td key={i} className={`px-4 py-3 ${col.align === 'right' ? 'text-right tabular-nums' : ''}`}>
                    {footer[col.key] !== undefined ? (col.footerRender ? col.footerRender(footer[col.key]) : footer[col.key]) : (i === 0 ? 'TOTAL' : '')}
                  </td>
                ))}
              </tr>
            </tfoot>
          )}
        </table>
      </div>
    );

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MAIN APPLICATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const App = () => {
      const [dark, setDark] = useState(() => localStorage.getItem('theme') === 'dark');
      const [tab, setTab] = useState('alltime');
      const [subTab, setSubTab] = useState('Performance Bridge');
      const [subTab2024, setSubTab2024] = useState('Performance Bridge');
      const [data, setData] = useState(() => {
        try { return JSON.parse(localStorage.getItem('portfolioData')); } catch { return null; }
      });
      const [importOpen, setImportOpen] = useState(false);
      const [files, setFiles] = useState({ h2023: [], h2024: [], h2025: [], trans: [] });
      const [txFilter, setTxFilter] = useState('All');
      const [txFilter2024, setTxFilter2024] = useState('All');

      useEffect(() => {
        document.documentElement.classList.toggle('dark', dark);
        localStorage.setItem('theme', dark ? 'dark' : 'light');
      }, [dark]);

      useEffect(() => {
        if (data) localStorage.setItem('portfolioData', JSON.stringify(data));
      }, [data]);

      const parseCSV = file => new Promise((res, rej) => Papa.parse(file, { header: true, skipEmptyLines: true, complete: r => res(r.data), error: rej }));

      const handleUpload = useCallback(async (e, type) => {
        const fileList = Array.from(e.target.files || []);
        if (!fileList.length) return;
        try {
          for (const file of fileList) {
            setFiles(f => ({ ...f, [type]: (f[type] || []).concat(file.name) }));
            if (type === 'h2023' || type === 'h2024' || type === 'h2025') {
              const h = processHoldings(await parseCSV(file));
              const key = type === 'h2023' ? 'holdings2023' : type === 'h2024' ? 'holdings2024' : 'holdings2025';
              setData(d => {
                const prev = (d && d[key]) ? d[key] : { totalValue: 0, totalCost: 0, accounts: {}, holdings: [] };
                const prevAccounts = prev.accounts || {};
                const prevHoldings = prev.holdings || [];
                return {
                  ...(d || {}),
                  [key]: {
                    totalValue: (prev.totalValue || 0) + h.totalValue,
                    totalCost: (prev.totalCost || 0) + h.totalCost,
                    accounts: Object.assign({}, prevAccounts, h.accounts),
                    holdings: prevHoldings.concat(h.holdings)
                  }
                };
              });
            } else {
              const t = processTransactions(await parseCSV(file));
              setData(d => {
                const prevTx = (d && d.transactions) ? d.transactions : [];
                const prevNames = (d && d.accountNames) ? d.accountNames : {};
                const prevAcctTx = (d && d.accountTx) ? d.accountTx : {};
                const prevTx2025 = (d && d.tx2025) ? d.tx2025 : {};
                return {
                  ...(d || {}),
                  accountNames: Object.assign({}, prevNames, t.names),
                  accountTx: Object.assign({}, prevAcctTx, t.acctTx),
                  transactions: prevTx.concat(t.all),
                  tx2025: {
                    purchases: (prevTx2025.purchases || 0) + t.purchases,
                    sales: (prevTx2025.sales || 0) + t.sales,
                    reinvested: (prevTx2025.reinvested || 0) + t.reinvested,
                    net: (prevTx2025.net || 0) + t.net
                  }
                };
              });
            }
          }
          e.target.value = '';
        } catch (err) {
          alert(`Error: ${err.message}`);
        }
      }, []);

      const clearData = useCallback(() => {
        if (confirm('Clear all portfolio data? This cannot be undone.')) {
          localStorage.removeItem('portfolioData');
          setData(null);
          setFiles({ h2023: [], h2024: [], h2025: [], trans: [] });
        }
      }, []);

      const exportData = useCallback(() => {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `portfolio-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
      }, [data]);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // COMPUTED VALUES
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const computed = useMemo(() => {
        if (!data?.holdings2025) return null;

        const filterHSA = (accounts, holdings) => {
          const names = data.accountNames || {};
          const filteredAccounts = {};
          Object.entries(accounts || {}).forEach(([num, acc]) => {
            if (!isHSA(names[num])) filteredAccounts[num] = acc;
          });
          const filteredHoldings = (holdings || []).filter(h => !isHSA(names[h.accountNumber]));
          return { accounts: filteredAccounts, holdings: filteredHoldings };
        };

        const h24 = filterHSA(data.holdings2024?.accounts, data.holdings2024?.holdings);
        const h25 = filterHSA(data.holdings2025?.accounts, data.holdings2025?.holdings);

        // SPAXX is a money market fund (cash equivalent) - extract it from holdings
        const CASH_SYMBOLS = ['SPAXX', 'FDRXX', 'FZFXX', 'SPRXX', 'VMFXX', 'CORE**']; // Common money market symbols
        const isCashHolding = (symbol) => CASH_SYMBOLS.some(cs => symbol?.toUpperCase().includes(cs.replace('*', '')));
        
        // Separate cash holdings from stock holdings
        const cashHoldings2024 = h24.holdings.filter(h => isCashHolding(h.symbol));
        const stockHoldings2024 = h24.holdings.filter(h => !isCashHolding(h.symbol));
        const cashHoldings2025 = h25.holdings.filter(h => isCashHolding(h.symbol));
        const stockHoldings2025 = h25.holdings.filter(h => !isCashHolding(h.symbol));
        
        // Cash position is the sum of all money market holdings
        const cash2024 = cashHoldings2024.reduce((s, h) => s + h.marketValue, 0);
        const cash2025 = cashHoldings2025.reduce((s, h) => s + h.marketValue, 0);
        
        const stocks2024 = stockHoldings2024.reduce((s, h) => s + h.marketValue, 0);
        const stocks2025 = stockHoldings2025.reduce((s, h) => s + h.marketValue, 0);
        const cost2025 = stockHoldings2025.reduce((s, h) => s + h.costBasis, 0);

        // Core values
        const startVal = stocks2024 + cash2024;
        const endVal = stocks2025 + cash2025;
        
        // Get 2025 transactions
        const tx = data.transactions || [];
        const tx2025 = tx.filter(t => t.date && new Date(t.date).getFullYear() === 2025 && t.type !== 'HSA');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONSISTENT TRANSACTION AGGREGATION (all positive values)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const purchases = tx2025.filter(t => t.type === 'Buy').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
        const sales = tx2025.filter(t => t.type === 'Sell').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
        const reinvested = tx2025.filter(t => t.type === 'Reinvestment').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
        const dividends = tx2025.filter(t => t.type === 'Dividend').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
        const cashFlow = tx2025.filter(t => t.type === 'Cash').reduce((s, t) => s + (t.amount || 0), 0); // Can be +/-
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MARKET GAIN CALCULATION
        // Formula: 2024 Start + Cash Flow + Dividends + Purchases + Reinvested - Sales + Market Gain = 2025 End
        // Therefore: Market Gain = 2025 End - 2024 Start - Cash Flow - Dividends - Purchases - Reinvested + Sales
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const marketGain = endVal - startVal - cashFlow - dividends - purchases - reinvested + sales;
        const investedCapital = startVal + purchases + reinvested - sales; // Capital at risk
        const marketGainPct = investedCapital > 0 ? (marketGain / investedCapital) * 100 : 0;
        
        // Other metrics
        const totalChange = endVal - startVal;
        const totalChangePct = startVal > 0 ? (totalChange / startVal) * 100 : 0;
        const unrealized = endVal - cost2025;
        const unrealizedPct = cost2025 > 0 ? (unrealized / cost2025) * 100 : 0;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WATERFALL CHART DATA
        // Each step shows positive for "adds to portfolio", negative for "removes from portfolio"
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let cumulative = startVal;
        const waterfall = [
          { name: '2024 Start', value: startVal, start: 0, end: startVal, type: 'anchor' },
        ];
        
        // Cash Flow (can be + or -)
        waterfall.push({ name: 'Cash Flow', value: cashFlow, start: cumulative, end: cumulative + cashFlow, type: 'step' });
        cumulative += cashFlow;
        
        // Dividends (always +, money received)
        waterfall.push({ name: 'Dividends', value: dividends, start: cumulative, end: cumulative + dividends, type: 'step' });
        cumulative += dividends;
        
        // Net Stock Activity: Purchases and Reinvested add, Sales subtract
        const netStockActivity = purchases + reinvested - sales;
        waterfall.push({ name: 'Net Invested', value: netStockActivity, start: cumulative, end: cumulative + netStockActivity, type: 'step' });
        cumulative += netStockActivity;
        
        // Market Gain (the residual)
        waterfall.push({ name: 'Market Gain', value: marketGain, start: cumulative, end: cumulative + marketGain, type: 'step' });
        cumulative += marketGain;
        
        waterfall.push({ name: '2025 End', value: endVal, start: 0, end: endVal, type: 'anchor' });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BY ACCOUNT ROIC
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const accountROIC = Object.entries(h25.accounts).map(([num, acc]) => {
          const name = data.accountNames?.[num] || num;
          const acctStart = h24.accounts[num]?.value || 0;
          
          // Get account-level transactions
          const acctTx2025 = tx2025.filter(t => normalize(t.accountNumber) === num);
          const acctPurchases = acctTx2025.filter(t => t.type === 'Buy').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
          const acctSales = acctTx2025.filter(t => t.type === 'Sell').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
          const acctReinvested = acctTx2025.filter(t => t.type === 'Reinvestment').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
          const acctDividends = acctTx2025.filter(t => t.type === 'Dividend').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
          
          const netIn = acctPurchases + acctReinvested - acctSales;
          const acctInvestedCapital = acctStart + acctPurchases + acctReinvested - acctSales;
          const acctMarketGain = acc.value - acctStart - netIn - acctDividends;
          const roic = acctInvestedCapital > 0 ? (acctMarketGain / acctInvestedCapital) * 100 : 0;
          
          return { num, name, start: acctStart, end: acc.value, netIn, dividends: acctDividends, marketGain: acctMarketGain, roic, costBasis: acc.costBasis, holdings: acc.holdings };
        }).filter(a => a.end > 0);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HOLDINGS ANALYSIS - aggregate by symbol (exclude cash holdings)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const holdingsMap = {};
        
        stockHoldings2024.forEach(h => {
          const key = h.symbol || h.description;
          if (!holdingsMap[key]) holdingsMap[key] = { symbol: h.symbol, description: h.description, val2024: 0, val2025: 0, dividends: 0, bought: 0, sold: 0, reinvested: 0 };
          holdingsMap[key].val2024 += h.marketValue;
        });
        
        stockHoldings2025.forEach(h => {
          const key = h.symbol || h.description;
          if (!holdingsMap[key]) holdingsMap[key] = { symbol: h.symbol, description: h.description, val2024: 0, val2025: 0, dividends: 0, bought: 0, sold: 0, reinvested: 0 };
          holdingsMap[key].val2025 += h.marketValue;
          holdingsMap[key].description = h.description || holdingsMap[key].description;
        });
        
        tx2025.forEach(t => {
          if (!t.symbol || isCashHolding(t.symbol)) return; // Skip cash holdings
          const key = t.symbol;
          if (!holdingsMap[key]) holdingsMap[key] = { symbol: t.symbol, description: t.description, val2024: 0, val2025: 0, dividends: 0, bought: 0, sold: 0, reinvested: 0 };
          const amt = Math.abs(t.amount || 0);
          if (t.type === 'Dividend') holdingsMap[key].dividends += amt;
          else if (t.type === 'Buy') holdingsMap[key].bought += amt;
          else if (t.type === 'Sell') holdingsMap[key].sold += amt;
          else if (t.type === 'Reinvestment') holdingsMap[key].reinvested += amt;
        });
        
        const holdingsAnalysis = Object.values(holdingsMap).map(h => {
          const netActivity = h.bought + h.reinvested - h.sold;
          const marketGain = h.val2025 - h.val2024 - netActivity;
          return { ...h, netActivity, marketGain };
        }).filter(h => h.val2024 > 0 || h.val2025 > 0 || h.dividends > 0 || h.bought > 0)
          .sort((a, b) => b.val2025 - a.val2025);

        return {
          cash2024, cash2025, stocks2024, stocks2025, cost2025,
          startVal, endVal, 
          purchases, sales, reinvested, dividends, cashFlow,
          marketGain, marketGainPct,
          unrealized, unrealizedPct, totalChange, totalChangePct,
          waterfall, accountROIC, holdingsAnalysis,
          accounts24: h24.accounts, accounts25: h25.accounts,
          holdings24: h24.holdings, holdings25: h25.holdings
        };
      }, [data]);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // COMPUTED VALUES FOR 2024
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const computed2024 = useMemo(() => {
        if (!data?.holdings2024) return null;

        const filterHSA = (accounts, holdings) => {
          const names = data.accountNames || {};
          const filteredAccounts = {};
          Object.entries(accounts || {}).forEach(([num, acc]) => {
            if (!isHSA(names[num])) filteredAccounts[num] = acc;
          });
          const filteredHoldings = (holdings || []).filter(h => !isHSA(names[h.accountNumber]));
          return { accounts: filteredAccounts, holdings: filteredHoldings };
        };

        const h23 = filterHSA(data.holdings2023?.accounts, data.holdings2023?.holdings);
        const h24 = filterHSA(data.holdings2024?.accounts, data.holdings2024?.holdings);

        // SPAXX is a money market fund (cash equivalent) - extract it from holdings
        const CASH_SYMBOLS = ['SPAXX', 'FDRXX', 'FZFXX', 'SPRXX', 'VMFXX', 'CORE**'];
        const isCashHolding = (symbol) => CASH_SYMBOLS.some(cs => symbol?.toUpperCase().includes(cs.replace('*', '')));
        
        const cashHoldings2023 = h23.holdings.filter(h => isCashHolding(h.symbol));
        const stockHoldings2023 = h23.holdings.filter(h => !isCashHolding(h.symbol));
        const cashHoldings2024 = h24.holdings.filter(h => isCashHolding(h.symbol));
        const stockHoldings2024 = h24.holdings.filter(h => !isCashHolding(h.symbol));
        
        const cash2023 = cashHoldings2023.reduce((s, h) => s + h.marketValue, 0);
        const cash2024 = cashHoldings2024.reduce((s, h) => s + h.marketValue, 0);
        
        const stocks2023 = stockHoldings2023.reduce((s, h) => s + h.marketValue, 0);
        const stocks2024 = stockHoldings2024.reduce((s, h) => s + h.marketValue, 0);
        const cost2024 = stockHoldings2024.reduce((s, h) => s + h.costBasis, 0);

        const startVal = stocks2023 + cash2023;
        const endVal = stocks2024 + cash2024;
        
        const tx = data.transactions || [];
        const tx2024 = tx.filter(t => t.date && new Date(t.date).getFullYear() === 2024 && t.type !== 'HSA');
        
        const purchases = tx2024.filter(t => t.type === 'Buy').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
        const sales = tx2024.filter(t => t.type === 'Sell').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
        const reinvested = tx2024.filter(t => t.type === 'Reinvestment').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
        const dividends = tx2024.filter(t => t.type === 'Dividend').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
        const cashFlow = tx2024.filter(t => t.type === 'Cash').reduce((s, t) => s + (t.amount || 0), 0);
        
        const marketGain = endVal - startVal - cashFlow - dividends - purchases - reinvested + sales;
        const investedCapital = startVal + purchases + reinvested - sales;
        const marketGainPct = investedCapital > 0 ? (marketGain / investedCapital) * 100 : 0;
        
        const totalChange = endVal - startVal;
        const totalChangePct = startVal > 0 ? (totalChange / startVal) * 100 : 0;
        const unrealized = endVal - cost2024;
        const unrealizedPct = cost2024 > 0 ? (unrealized / cost2024) * 100 : 0;

        // Waterfall
        let cumulative = startVal;
        const waterfall = [
          { name: '2023 Start', value: startVal, start: 0, end: startVal, type: 'anchor' },
        ];
        
        waterfall.push({ name: 'Cash Flow', value: cashFlow, start: cumulative, end: cumulative + cashFlow, type: 'step' });
        cumulative += cashFlow;
        
        waterfall.push({ name: 'Dividends', value: dividends, start: cumulative, end: cumulative + dividends, type: 'step' });
        cumulative += dividends;
        
        const netStockActivity = purchases + reinvested - sales;
        waterfall.push({ name: 'Net Invested', value: netStockActivity, start: cumulative, end: cumulative + netStockActivity, type: 'step' });
        cumulative += netStockActivity;
        
        waterfall.push({ name: 'Market Gain', value: marketGain, start: cumulative, end: cumulative + marketGain, type: 'step' });
        cumulative += marketGain;
        
        waterfall.push({ name: '2024 End', value: endVal, start: 0, end: endVal, type: 'anchor' });

        // By Account ROIC
        const accountROIC = Object.entries(h24.accounts).map(([num, acc]) => {
          const name = data.accountNames?.[num] || num;
          const acctStart = h23.accounts[num]?.value || 0;
          
          const acctTx2024 = tx2024.filter(t => normalize(t.accountNumber) === num);
          const acctPurchases = acctTx2024.filter(t => t.type === 'Buy').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
          const acctSales = acctTx2024.filter(t => t.type === 'Sell').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
          const acctReinvested = acctTx2024.filter(t => t.type === 'Reinvestment').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
          const acctDividends = acctTx2024.filter(t => t.type === 'Dividend').reduce((s, t) => s + Math.abs(t.amount || 0), 0);
          
          const netIn = acctPurchases + acctReinvested - acctSales;
          const acctInvestedCapital = acctStart + acctPurchases + acctReinvested - acctSales;
          const acctMarketGain = acc.value - acctStart - netIn - acctDividends;
          const roic = acctInvestedCapital > 0 ? (acctMarketGain / acctInvestedCapital) * 100 : 0;
          
          return { num, name, start: acctStart, end: acc.value, netIn, dividends: acctDividends, marketGain: acctMarketGain, roic, costBasis: acc.costBasis, holdings: acc.holdings };
        }).filter(a => a.end > 0);

        // Holdings Analysis (exclude cash holdings)
        const holdingsMap = {};
        
        stockHoldings2023.forEach(h => {
          const key = h.symbol || h.description;
          if (!holdingsMap[key]) holdingsMap[key] = { symbol: h.symbol, description: h.description, val2023: 0, val2024: 0, dividends: 0, bought: 0, sold: 0, reinvested: 0 };
          holdingsMap[key].val2023 += h.marketValue;
        });
        
        stockHoldings2024.forEach(h => {
          const key = h.symbol || h.description;
          if (!holdingsMap[key]) holdingsMap[key] = { symbol: h.symbol, description: h.description, val2023: 0, val2024: 0, dividends: 0, bought: 0, sold: 0, reinvested: 0 };
          holdingsMap[key].val2024 += h.marketValue;
          holdingsMap[key].description = h.description || holdingsMap[key].description;
        });
        
        tx2024.forEach(t => {
          if (!t.symbol || isCashHolding(t.symbol)) return; // Skip cash holdings
          const key = t.symbol;
          if (!holdingsMap[key]) holdingsMap[key] = { symbol: t.symbol, description: t.description, val2023: 0, val2024: 0, dividends: 0, bought: 0, sold: 0, reinvested: 0 };
          const amt = Math.abs(t.amount || 0);
          if (t.type === 'Dividend') holdingsMap[key].dividends += amt;
          else if (t.type === 'Buy') holdingsMap[key].bought += amt;
          else if (t.type === 'Sell') holdingsMap[key].sold += amt;
          else if (t.type === 'Reinvestment') holdingsMap[key].reinvested += amt;
        });
        
        const holdingsAnalysis = Object.values(holdingsMap).map(h => {
          const netActivity = h.bought + h.reinvested - h.sold;
          const marketGain = h.val2024 - h.val2023 - netActivity;
          return { ...h, netActivity, marketGain };
        }).filter(h => h.val2023 > 0 || h.val2024 > 0 || h.dividends > 0 || h.bought > 0)
          .sort((a, b) => b.val2024 - a.val2024);

        return {
          cash2023, cash2024, stocks2023, stocks2024, cost2024,
          startVal, endVal, 
          purchases, sales, reinvested, dividends, cashFlow,
          marketGain, marketGainPct,
          unrealized, unrealizedPct, totalChange, totalChangePct,
          waterfall, accountROIC, holdingsAnalysis,
          accounts23: h23.accounts, accounts24: h24.accounts,
          holdings23: h23.holdings, holdings24: h24.holdings
        };
      }, [data]);

      const filteredTx = useMemo(() => {
        const all = (data?.transactions || []).filter(t => t.date && new Date(t.date).getFullYear() === 2025);
        return txFilter === 'All' ? all : all.filter(t => t.type === txFilter);
      }, [data, txFilter]);

      const filteredTx2024 = useMemo(() => {
        const all = (data?.transactions || []).filter(t => t.date && new Date(t.date).getFullYear() === 2024);
        return txFilter2024 === 'All' ? all : all.filter(t => t.type === txFilter2024);
      }, [data, txFilter2024]);

      const hasData = !!computed;

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // RENDER
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      return (
        <div className="min-h-screen">
          {/* Header */}
          <header className="sticky top-0 z-50 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-800">
            <div className="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-8 h-8 rounded-lg bg-accent flex items-center justify-center">
                  <span className="text-white font-bold text-sm">P</span>
                </div>
                <h1 className="text-lg font-semibold text-gray-900 dark:text-white">Portfolio Analytics</h1>
                <Badge variant="accent">Local Storage</Badge>
              </div>
              <div className="flex items-center gap-2">
                <Button onClick={() => setDark(!dark)} icon={dark ? <Icons.sun /> : <Icons.moon />} size="sm">
                  {dark ? 'Light' : 'Dark'}
                </Button>
                {hasData && (
                  <>
                    <Button onClick={exportData} icon={<Icons.download />} size="sm">Export</Button>
                    <Button onClick={clearData} variant="danger" icon={<Icons.trash />} size="sm">Clear</Button>
                  </>
                )}
              </div>
            </div>
          </header>

          <main className="max-w-6xl mx-auto px-6 py-8 space-y-6">
            {/* Import Section */}
            <Card>
              <button onClick={() => setImportOpen(!importOpen)} className="w-full px-5 py-4 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors rounded-xl">
                <div className="flex items-center gap-3">
                  <Icons.upload />
                  <span className="font-medium text-gray-900 dark:text-white">Import Data</span>
                  {(files.h2023.length + files.h2024.length + files.h2025.length + files.trans.length) > 0 && (
                    <Badge variant="success">{files.h2023.length + files.h2024.length + files.h2025.length + files.trans.length} files</Badge>
                  )}
                </div>
                <div className={`transition-transform ${importOpen ? 'rotate-180' : ''}`}><Icons.chevron /></div>
              </button>
              {importOpen && (
                <div className="px-5 pb-5 border-t border-gray-100 dark:border-gray-700 pt-4 animate-fadeUp">
                  <div className="grid md:grid-cols-4 gap-4">
                    {[
                      { key: 'h2023', label: 'Holdings 2023', desc: 'Year-end 2023 positions' },
                      { key: 'h2024', label: 'Holdings 2024', desc: 'Year-end 2024 positions' },
                      { key: 'h2025', label: 'Holdings 2025', desc: 'Current positions' },
                      { key: 'trans', label: 'Transactions', desc: 'All transactions (any year)' }
                    ].map(({ key, label, desc }) => (
                      <div key={key} className="space-y-2">
                        <label className="block">
                          <span className="text-sm font-medium text-gray-700 dark:text-gray-300">{label}</span>
                          {files[key].length > 0 && <Badge variant="success" className="ml-2">{files[key].length}</Badge>}
                          <span className="block text-xs text-gray-500 dark:text-gray-400 mt-0.5">{desc}</span>
                        </label>
                        <input type="file" accept=".csv" multiple onChange={e => handleUpload(e, key)}
                          className="block w-full text-sm text-gray-500 dark:text-gray-400" />
                      </div>
                    ))}
                  </div>
                  <div className="mt-4 p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
                    <p className="text-xs text-amber-800 dark:text-amber-200">
                      <strong>Note:</strong> HSA accounts are automatically excluded. Cash balance starts at {fmt.currencyFull(STARTING_CASH)} and tracks deposits, withdrawals, and margin interest.
                    </p>
                  </div>
                </div>
              )}
            </Card>

            {!hasData ? (
              <Card className="py-20 text-center">
                <div className="text-5xl mb-4">ğŸ“Š</div>
                <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-2">No Data Yet</h2>
                <p className="text-gray-500 dark:text-gray-400">Upload your CSV files above to get started</p>
              </Card>
            ) : (
              <>
                {/* Cash Balance Summary */}
                <Card className="px-5 py-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Cash / Margin Balance</div>
                      <div className="flex items-center gap-6">
                        <div>
                          <span className="text-sm text-gray-500 dark:text-gray-400">2024: </span>
                          <span className={`font-semibold tabular-nums ${computed.cash2024 >= 0 ? 'text-success' : 'text-danger'}`}>
                            {fmt.currencyFull(computed.cash2024)}
                          </span>
                        </div>
                        <div>
                          <span className="text-sm text-gray-500 dark:text-gray-400">2025: </span>
                          <span className={`font-semibold tabular-nums ${computed.cash2025 >= 0 ? 'text-success' : 'text-danger'}`}>
                            {fmt.currencyFull(computed.cash2025)}
                          </span>
                        </div>
                      </div>
                    </div>
                    <Badge variant={computed.cash2025 >= 0 ? 'success' : 'danger'}>
                      {computed.cash2025 >= 0 ? 'ğŸ’° Cash' : 'ğŸ“Š Margin'}
                    </Badge>
                  </div>
                </Card>

                {/* Main Tabs */}
                <Card>
                  <Tabs
                    tabs={[
                      { id: 'alltime', label: 'All-Time Performance', icon: <Icons.chart /> },
                      { id: '2024', label: '2024 Year-in-Review', icon: <Icons.calendar /> },
                      { id: '2025', label: '2025 Year-in-Review', icon: <Icons.calendar /> }
                    ]}
                    active={tab}
                    onChange={setTab}
                  />

                  <div className="p-6">
                    {tab === 'alltime' && (
                      <div className="space-y-6 animate-fadeUp">
                        {/* Stats Grid */}
                        <div className="grid md:grid-cols-3 gap-4">
                          <Card hover><Stat label="Total Portfolio Value" value={fmt.currency(computed.endVal)} sub={`Stocks: ${fmt.compact(computed.stocks2025)} Â· Cash: ${fmt.compact(computed.cash2025)}`} /></Card>
                          <Card hover><Stat label="Total Cost Basis" value={fmt.currency(computed.cost2025)} sub="Stocks only (excl. HSA)" /></Card>
                          <Card hover className="border-accent/30"><Stat label="Lifetime Unrealized Gain" value={fmt.currency(computed.unrealized)} trend={computed.unrealizedPct} accent /></Card>
                        </div>

                        {/* Holdings Breakdown */}
                        <Card>
                          <div className="px-5 py-4 border-b border-gray-100 dark:border-gray-700">
                            <h2 className="font-semibold text-gray-900 dark:text-white">Holdings Breakdown</h2>
                            <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">HSA accounts excluded</p>
                          </div>
                          <div className="divide-y divide-gray-100 dark:divide-gray-700">
                            {Math.abs(computed.cash2025) > 100 && (
                              <div className="px-5 py-4 flex items-center justify-between">
                                <div>
                                  <div className="font-medium text-gray-900 dark:text-white">
                                    {computed.cash2025 >= 0 ? 'ğŸ’µ Cash Balance' : 'ğŸ“Š Margin Loan'}
                                  </div>
                                  <div className="text-xs text-gray-500 dark:text-gray-400">Deposits, withdrawals, interest</div>
                                </div>
                                <div className="text-right">
                                  <div className={`text-lg font-semibold tabular-nums ${computed.cash2025 >= 0 ? 'text-success' : 'text-danger'}`}>
                                    {fmt.currencyFull(Math.abs(computed.cash2025))}
                                  </div>
                                  <div className="text-xs text-gray-500 dark:text-gray-400">
                                    {Math.abs(computed.cash2025 / computed.endVal * 100).toFixed(1)}% of portfolio
                                  </div>
                                </div>
                              </div>
                            )}
                            {Object.entries(computed.accounts25).map(([num, acc]) => {
                              const name = data.accountNames?.[num] || num;
                              const gain = acc.value - acc.costBasis;
                              const gainPct = acc.costBasis > 0 ? (gain / acc.costBasis) * 100 : 0;
                              const pct = computed.stocks2025 > 0 ? (acc.value / computed.stocks2025) * 100 : 0;
                              if (acc.value === 0) return null;
                              return (
                                <div key={num} className="px-5 py-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                                  <div>
                                    <div className="font-medium text-gray-900 dark:text-white">{name}</div>
                                    <div className="text-xs text-gray-500 dark:text-gray-400">{acc.holdings} holdings Â· {num}</div>
                                  </div>
                                  <div className="text-right">
                                    <div className="text-lg font-semibold tabular-nums text-gray-900 dark:text-white">{fmt.currencyFull(acc.value)}</div>
                                    <div className={`text-sm tabular-nums ${gain >= 0 ? 'text-success' : 'text-danger'}`}>
                                      {fmt.currencyFull(gain)} ({fmt.percent(gainPct)})
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </Card>
                      </div>
                    )}

                    {tab === '2025' && (
                      <div className="space-y-6 animate-fadeUp">
                        {/* Summary Stats */}
                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                          <Card><Stat label="2025 Value" value={fmt.compact(computed.endVal)} sub={fmt.percent(computed.totalChangePct) + ' vs 2024'} /></Card>
                          <Card><Stat label="2024 Start" value={fmt.compact(computed.startVal)} sub="Stocks + Cash" /></Card>
                          <Card><Stat label="Dividends" value={fmt.compact(computed.dividends)} sub="Cash received" /></Card>
                          <Card><Stat label="Net Invested" value={fmt.compact(computed.purchases + computed.reinvested - computed.sales)} sub="Buys + Reinv âˆ’ Sells" /></Card>
                          <Card className="border-accent/30"><Stat label="Market Gain" value={fmt.compact(computed.marketGain)} sub={`ROIC: ${fmt.percent(computed.marketGainPct)}`} accent /></Card>
                          <Card><Stat label="Purchases" value={fmt.compact(computed.purchases)} /></Card>
                          <Card><Stat label="Sales" value={fmt.compact(computed.sales)} /></Card>
                        </div>

                        {/* Sub Navigation */}
                        <SubTabs tabs={['Performance Bridge', 'By Account', 'Holdings', 'Transactions']} active={subTab} onChange={setSubTab} />

                        {/* Sub Tab Content */}
                        {subTab === 'Performance Bridge' && (
                          <Card>
                            <div className="px-5 py-4 border-b border-gray-100 dark:border-gray-700">
                              <h2 className="font-semibold text-gray-900 dark:text-white">2025 Performance Bridge</h2>
                              <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">How did we get from 2024 to 2025?</p>
                            </div>
                            <div className="p-5">
                              <div className="grid grid-cols-4 gap-3 mb-6">
                                {computed.waterfall.filter(d => d.type === 'step').map((s, i) => (
                                  <Card key={i} className="p-4">
                                    <div className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">{s.name}</div>
                                    <div className={`text-xl font-semibold tabular-nums mt-1 ${s.value >= 0 ? 'text-success' : 'text-danger'}`}>
                                      {s.value >= 0 ? '+' : ''}{fmt.compact(s.value)}
                                    </div>
                                    <div className="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                      {s.value >= 0 ? 'â–²' : 'â–¼'} {Math.abs((s.value / computed.startVal) * 100).toFixed(1)}%
                                    </div>
                                  </Card>
                                ))}
                              </div>
                              <Card className="p-4 mb-6 border-accent/30 bg-accent/5 dark:bg-accent/10">
                                <div className="flex items-center justify-between">
                                  <div className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Total Change 2024 â†’ 2025</div>
                                  <div className="flex items-center gap-4">
                                    <div className={`text-2xl font-bold tabular-nums ${computed.totalChange >= 0 ? 'text-success' : 'text-danger'}`}>
                                      {computed.totalChange >= 0 ? '+' : ''}{fmt.compact(computed.totalChange)}
                                    </div>
                                    <div className={`text-lg font-semibold tabular-nums ${computed.totalChangePct >= 0 ? 'text-success' : 'text-danger'}`}>
                                      ({fmt.percent(computed.totalChangePct)})
                                    </div>
                                  </div>
                                </div>
                              </Card>
                              <div className="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4">
                                <WaterfallChart data={computed.waterfall} />
                              </div>
                              <div className="mt-4 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Understanding the Bridge</h3>
                                <div className="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                  <p><strong>Cash Flow:</strong> Deposits, withdrawals, margin interest (can be + or âˆ’)</p>
                                  <p><strong>Dividends:</strong> Cash dividends received</p>
                                  <p><strong>Net Invested:</strong> Purchases + Reinvested âˆ’ Sales (new capital deployed)</p>
                                  <p><strong>Market Gain:</strong> Price appreciation (the residual)</p>
                                </div>
                                <p className="text-xs text-gray-400 dark:text-gray-500 mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                                  <strong>Formula:</strong> 2024 Start + Cash Flow + Dividends + Net Invested + Market Gain = 2025 End
                                </p>
                              </div>
                            </div>
                          </Card>
                        )}

                        {subTab === 'By Account' && (
                          <Card>
                            <div className="px-5 py-4 border-b border-gray-100 dark:border-gray-700">
                              <h2 className="font-semibold text-gray-900 dark:text-white">Account Performance & ROIC</h2>
                              <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Return on invested capital by account</p>
                            </div>
                            <Table
                              columns={[
                                { key: 'name', header: 'Account' },
                                { key: 'start', header: '2024 Value', align: 'right', render: v => fmt.currencyFull(v), footerRender: v => fmt.currencyFull(v) },
                                { key: 'netIn', header: 'Net Invested', align: 'right', render: v => <span className={v >= 0 ? 'text-accent' : 'text-danger'}>{fmt.currencyFull(v)}</span>, footerRender: v => <span className={v >= 0 ? 'text-accent' : 'text-danger'}>{fmt.currencyFull(v)}</span> },
                                { key: 'dividends', header: 'Dividends', align: 'right', render: v => <span className="text-success">{fmt.currencyFull(v)}</span>, footerRender: v => <span className="text-success">{fmt.currencyFull(v)}</span> },
                                { key: 'marketGain', header: 'Market Gain', align: 'right', render: v => <span className={v >= 0 ? 'text-success' : 'text-danger'}>{fmt.currencyFull(v)}</span>, footerRender: v => <span className={v >= 0 ? 'text-success' : 'text-danger'}>{fmt.currencyFull(v)}</span> },
                                { key: 'end', header: '2025 Value', align: 'right', render: v => <span className="font-semibold">{fmt.currencyFull(v)}</span>, footerRender: v => <span className="font-semibold">{fmt.currencyFull(v)}</span> },
                                { key: 'roic', header: 'ROIC', align: 'right', render: v => <span className={`font-semibold ${v >= 0 ? 'text-success' : 'text-danger'}`}>{fmt.percent(v)}</span>, footerRender: v => <span className={`font-semibold ${v >= 0 ? 'text-success' : 'text-danger'}`}>{fmt.percent(v)}</span> },
                              ]}
                              data={computed.accountROIC}
                              footer={{
                                start: computed.accountROIC.reduce((s, a) => s + a.start, 0),
                                netIn: computed.accountROIC.reduce((s, a) => s + a.netIn, 0),
                                dividends: computed.accountROIC.reduce((s, a) => s + a.dividends, 0),
                                marketGain: computed.accountROIC.reduce((s, a) => s + a.marketGain, 0),
                                end: computed.accountROIC.reduce((s, a) => s + a.end, 0),
                                roic: computed.marketGainPct
                              }}
                            />
                            <div className="px-5 py-3 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700">
                              <p className="text-xs text-gray-500 dark:text-gray-400">
                                <strong>Formula:</strong> 2024 Value + Net Invested + Dividends + Market Gain = 2025 Value
                              </p>
                            </div>
                          </Card>
                        )}

                        {subTab === 'Holdings' && (
                          <Card>
                            <div className="px-5 py-4 border-b border-gray-100 dark:border-gray-700">
                              <h2 className="font-semibold text-gray-900 dark:text-white">Holdings Analysis</h2>
                              <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">{computed.holdingsAnalysis.length} symbols Â· Year-over-year breakdown</p>
                            </div>
                            <Table
                              maxHeight="500px"
                              columns={[
                                { key: 'symbol', header: 'Symbol', render: (v, r) => <div><div className="font-medium">{v || 'â€”'}</div><div className="text-xs text-gray-400 truncate max-w-40">{r.description}</div></div> },
                                { key: 'val2024', header: '2024 Value', align: 'right', render: v => v > 0 ? fmt.currencyFull(v) : <span className="text-gray-400">â€”</span>, footerRender: v => fmt.currencyFull(v) },
                                { key: 'dividends', header: 'Dividends', align: 'right', render: v => v > 0 ? <span className="text-success">{fmt.currencyFull(v)}</span> : <span className="text-gray-400">â€”</span>, footerRender: v => <span className="text-success">{fmt.currencyFull(v)}</span> },
                                { key: 'bought', header: 'Bought', align: 'right', render: v => v > 0 ? <span className="text-accent">{fmt.currencyFull(v)}</span> : <span className="text-gray-400">â€”</span>, footerRender: v => <span className="text-accent">{fmt.currencyFull(v)}</span> },
                                { key: 'sold', header: 'Sold', align: 'right', render: v => v > 0 ? <span className="text-danger">{fmt.currencyFull(v)}</span> : <span className="text-gray-400">â€”</span>, footerRender: v => <span className="text-danger">{fmt.currencyFull(v)}</span> },
                                { key: 'reinvested', header: 'Reinvested', align: 'right', render: v => v > 0 ? <span className="text-success">{fmt.currencyFull(v)}</span> : <span className="text-gray-400">â€”</span>, footerRender: v => <span className="text-success">{fmt.currencyFull(v)}</span> },
                                { key: 'marketGain', header: 'Market Gain', align: 'right', render: v => <span className={v >= 0 ? 'text-success' : 'text-danger'}>{fmt.currencyFull(v)}</span>, footerRender: v => <span className={v >= 0 ? 'text-success' : 'text-danger'}>{fmt.currencyFull(v)}</span> },
                                { key: 'val2025', header: '2025 Value', align: 'right', render: v => v > 0 ? <span className="font-semibold">{fmt.currencyFull(v)}</span> : <span className="text-gray-400">â€”</span>, footerRender: v => <span className="font-semibold">{fmt.currencyFull(v)}</span> },
                                { key: 'roic', header: 'ROIC', align: 'right', render: (v, r) => { const base = r.val2024 + r.bought + r.reinvested - r.sold; const roic = base > 0 ? (r.marketGain / base) * 100 : 0; return <span className={`font-semibold ${roic >= 0 ? 'text-success' : 'text-danger'}`}>{fmt.percent(roic)}</span>; }, footerRender: v => <span className={`font-semibold ${v >= 0 ? 'text-success' : 'text-danger'}`}>{fmt.percent(v)}</span> },
                              ]}
                              data={computed.holdingsAnalysis}
                              footer={{
                                val2024: computed.holdingsAnalysis.reduce((s, h) => s + h.val2024, 0),
                                dividends: computed.holdingsAnalysis.reduce((s, h) => s + h.dividends, 0),
                                bought: computed.holdingsAnalysis.reduce((s, h) => s + h.bought, 0),
                                sold: computed.holdingsAnalysis.reduce((s, h) => s + h.sold, 0),
                                reinvested: computed.holdingsAnalysis.reduce((s, h) => s + h.reinvested, 0),
                                marketGain: computed.holdingsAnalysis.reduce((s, h) => s + h.marketGain, 0),
                                val2025: computed.holdingsAnalysis.reduce((s, h) => s + h.val2025, 0),
                                roic: computed.marketGainPct
                              }}
                            />
                            <div className="px-5 py-3 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700">
                              <p className="text-xs text-gray-500 dark:text-gray-400">
                                <strong>Formula:</strong> 2024 Value + Bought + Reinvested âˆ’ Sold + Market Gain = 2025 Value Â· <strong>ROIC</strong> = Market Gain / (2024 Value + Bought + Reinvested âˆ’ Sold)
                              </p>
                            </div>
                          </Card>
                        )}

                        {subTab === 'Transactions' && (
                          <Card>
                            <div className="px-5 py-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
                              <div>
                                <h2 className="font-semibold text-gray-900 dark:text-white">Transaction History</h2>
                                <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">{filteredTx.length} transactions</p>
                              </div>
                              <select value={txFilter} onChange={e => setTxFilter(e.target.value)}
                                className="text-sm border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-1.5 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200">
                                {['All', 'Buy', 'Sell', 'Dividend', 'Reinvestment', 'Cash', 'HSA', 'Other'].map(t => <option key={t}>{t}</option>)}
                              </select>
                            </div>
                            <Table
                              maxHeight="500px"
                              columns={[
                                { key: 'date', header: 'Date', mono: true },
                                { key: 'type', header: 'Type', render: v => {
                                  const colors = { Buy: 'accent', Sell: 'danger', Dividend: 'success', Reinvestment: 'success', Cash: 'default', HSA: 'default', Other: 'default' };
                                  return <Badge variant={colors[v] || 'default'}>{v}</Badge>;
                                }},
                                { key: 'symbol', header: 'Symbol', render: v => v || 'â€”' },
                                { key: 'action', header: 'Action', render: v => <span className="text-xs text-gray-500 truncate max-w-64 block">{v}</span> },
                                { key: 'amount', header: 'Amount', align: 'right', render: (v, r) => {
                                  const displayAmt = (r.type === 'Buy' || r.type === 'Reinvestment') ? Math.abs(v) : v;
                                  const isPositive = displayAmt >= 0;
                                  return <span className={isPositive ? 'text-success' : 'text-danger'}>{fmt.currencyFull(displayAmt)}</span>;
                                }, footerRender: v => <span className={v >= 0 ? 'text-success' : 'text-danger'}>{fmt.currencyFull(v)}</span> },
                              ]}
                              data={filteredTx}
                              footer={{
                                amount: filteredTx.reduce((s, t) => s + ((t.type === 'Buy' || t.type === 'Reinvestment') ? Math.abs(t.amount || 0) : (t.amount || 0)), 0)
                              }}
                            />
                          </Card>
                        )}
                      </div>
                    )}

                    {tab === '2024' && computed2024 && (
                      <div className="space-y-6 animate-fadeUp">
                        {/* Summary Stats */}
                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                          <Card><Stat label="2024 Value" value={fmt.compact(computed2024.endVal)} sub={fmt.percent(computed2024.totalChangePct) + ' vs 2023'} /></Card>
                          <Card><Stat label="2023 Start" value={fmt.compact(computed2024.startVal)} sub="Stocks + Cash" /></Card>
                          <Card><Stat label="Dividends" value={fmt.compact(computed2024.dividends)} sub="Cash received" /></Card>
                          <Card><Stat label="Net Invested" value={fmt.compact(computed2024.purchases + computed2024.reinvested - computed2024.sales)} sub="Buys + Reinv âˆ’ Sells" /></Card>
                          <Card className="border-accent/30"><Stat label="Market Gain" value={fmt.compact(computed2024.marketGain)} sub={`ROIC: ${fmt.percent(computed2024.marketGainPct)}`} accent /></Card>
                          <Card><Stat label="Purchases" value={fmt.compact(computed2024.purchases)} /></Card>
                          <Card><Stat label="Sales" value={fmt.compact(computed2024.sales)} /></Card>
                        </div>

                        {/* Sub Navigation */}
                        <SubTabs tabs={['Performance Bridge', 'By Account', 'Holdings', 'Transactions']} active={subTab2024} onChange={setSubTab2024} />

                        {/* Sub Tab Content */}
                        {subTab2024 === 'Performance Bridge' && (
                          <Card>
                            <div className="px-5 py-4 border-b border-gray-100 dark:border-gray-700">
                              <h2 className="font-semibold text-gray-900 dark:text-white">2024 Performance Bridge</h2>
                              <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">How did we get from 2023 to 2024?</p>
                            </div>
                            <div className="p-5">
                              <div className="grid grid-cols-4 gap-3 mb-6">
                                {computed2024.waterfall.filter(d => d.type === 'step').map((s, i) => (
                                  <Card key={i} className="p-4">
                                    <div className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">{s.name}</div>
                                    <div className={`text-xl font-semibold tabular-nums mt-1 ${s.value >= 0 ? 'text-success' : 'text-danger'}`}>
                                      {s.value >= 0 ? '+' : ''}{fmt.compact(s.value)}
                                    </div>
                                    <div className="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                      {s.value >= 0 ? 'â–²' : 'â–¼'} {Math.abs((s.value / computed2024.startVal) * 100).toFixed(1)}%
                                    </div>
                                  </Card>
                                ))}
                              </div>
                              <Card className="p-4 mb-6 border-accent/30 bg-accent/5 dark:bg-accent/10">
                                <div className="flex items-center justify-between">
                                  <div className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Total Change 2023 â†’ 2024</div>
                                  <div className="flex items-center gap-4">
                                    <div className={`text-2xl font-bold tabular-nums ${computed2024.totalChange >= 0 ? 'text-success' : 'text-danger'}`}>
                                      {computed2024.totalChange >= 0 ? '+' : ''}{fmt.compact(computed2024.totalChange)}
                                    </div>
                                    <div className={`text-lg font-semibold tabular-nums ${computed2024.totalChangePct >= 0 ? 'text-success' : 'text-danger'}`}>
                                      ({fmt.percent(computed2024.totalChangePct)})
                                    </div>
                                  </div>
                                </div>
                              </Card>
                              <div className="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4">
                                <WaterfallChart data={computed2024.waterfall} />
                              </div>
                              <div className="mt-4 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Understanding the Bridge</h3>
                                <div className="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                  <p><strong>Cash Flow:</strong> Deposits, withdrawals, margin interest (can be + or âˆ’)</p>
                                  <p><strong>Dividends:</strong> Cash dividends received</p>
                                  <p><strong>Net Invested:</strong> Purchases + Reinvested âˆ’ Sales (new capital deployed)</p>
                                  <p><strong>Market Gain:</strong> Price appreciation (the residual)</p>
                                </div>
                                <p className="text-xs text-gray-400 dark:text-gray-500 mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                                  <strong>Formula:</strong> 2023 Start + Cash Flow + Dividends + Net Invested + Market Gain = 2024 End
                                </p>
                              </div>
                            </div>
                          </Card>
                        )}

                        {subTab2024 === 'By Account' && (
                          <Card>
                            <div className="px-5 py-4 border-b border-gray-100 dark:border-gray-700">
                              <h2 className="font-semibold text-gray-900 dark:text-white">Account Performance & ROIC</h2>
                              <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Return on invested capital by account</p>
                            </div>
                            <Table
                              columns={[
                                { key: 'name', header: 'Account' },
                                { key: 'start', header: '2023 Value', align: 'right', render: v => fmt.currencyFull(v), footerRender: v => fmt.currencyFull(v) },
                                { key: 'netIn', header: 'Net Invested', align: 'right', render: v => <span className={v >= 0 ? 'text-accent' : 'text-danger'}>{fmt.currencyFull(v)}</span>, footerRender: v => <span className={v >= 0 ? 'text-accent' : 'text-danger'}>{fmt.currencyFull(v)}</span> },
                                { key: 'dividends', header: 'Dividends', align: 'right', render: v => <span className="text-success">{fmt.currencyFull(v)}</span>, footerRender: v => <span className="text-success">{fmt.currencyFull(v)}</span> },
                                { key: 'marketGain', header: 'Market Gain', align: 'right', render: v => <span className={v >= 0 ? 'text-success' : 'text-danger'}>{fmt.currencyFull(v)}</span>, footerRender: v => <span className={v >= 0 ? 'text-success' : 'text-danger'}>{fmt.currencyFull(v)}</span> },
                                { key: 'end', header: '2024 Value', align: 'right', render: v => <span className="font-semibold">{fmt.currencyFull(v)}</span>, footerRender: v => <span className="font-semibold">{fmt.currencyFull(v)}</span> },
                                { key: 'roic', header: 'ROIC', align: 'right', render: v => <span className={`font-semibold ${v >= 0 ? 'text-success' : 'text-danger'}`}>{fmt.percent(v)}</span>, footerRender: v => <span className={`font-semibold ${v >= 0 ? 'text-success' : 'text-danger'}`}>{fmt.percent(v)}</span> },
                              ]}
                              data={computed2024.accountROIC}
                              footer={{
                                start: computed2024.accountROIC.reduce((s, a) => s + a.start, 0),
                                netIn: computed2024.accountROIC.reduce((s, a) => s + a.netIn, 0),
                                dividends: computed2024.accountROIC.reduce((s, a) => s + a.dividends, 0),
                                marketGain: computed2024.accountROIC.reduce((s, a) => s + a.marketGain, 0),
                                end: computed2024.accountROIC.reduce((s, a) => s + a.end, 0),
                                roic: computed2024.marketGainPct
                              }}
                            />
                            <div className="px-5 py-3 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700">
                              <p className="text-xs text-gray-500 dark:text-gray-400">
                                <strong>Formula:</strong> 2023 Value + Net Invested + Dividends + Market Gain = 2024 Value
                              </p>
                            </div>
                          </Card>
                        )}

                        {subTab2024 === 'Holdings' && (
                          <Card>
                            <div className="px-5 py-4 border-b border-gray-100 dark:border-gray-700">
                              <h2 className="font-semibold text-gray-900 dark:text-white">Holdings Analysis</h2>
                              <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">{computed2024.holdingsAnalysis.length} symbols Â· Year-over-year breakdown</p>
                            </div>
                            <Table
                              maxHeight="500px"
                              columns={[
                                { key: 'symbol', header: 'Symbol', render: (v, r) => <div><div className="font-medium">{v || 'â€”'}</div><div className="text-xs text-gray-400 truncate max-w-40">{r.description}</div></div> },
                                { key: 'val2023', header: '2023 Value', align: 'right', render: v => v > 0 ? fmt.currencyFull(v) : <span className="text-gray-400">â€”</span>, footerRender: v => fmt.currencyFull(v) },
                                { key: 'dividends', header: 'Dividends', align: 'right', render: v => v > 0 ? <span className="text-success">{fmt.currencyFull(v)}</span> : <span className="text-gray-400">â€”</span>, footerRender: v => <span className="text-success">{fmt.currencyFull(v)}</span> },
                                { key: 'bought', header: 'Bought', align: 'right', render: v => v > 0 ? <span className="text-accent">{fmt.currencyFull(v)}</span> : <span className="text-gray-400">â€”</span>, footerRender: v => <span className="text-accent">{fmt.currencyFull(v)}</span> },
                                { key: 'sold', header: 'Sold', align: 'right', render: v => v > 0 ? <span className="text-danger">{fmt.currencyFull(v)}</span> : <span className="text-gray-400">â€”</span>, footerRender: v => <span className="text-danger">{fmt.currencyFull(v)}</span> },
                                { key: 'reinvested', header: 'Reinvested', align: 'right', render: v => v > 0 ? <span className="text-success">{fmt.currencyFull(v)}</span> : <span className="text-gray-400">â€”</span>, footerRender: v => <span className="text-success">{fmt.currencyFull(v)}</span> },
                                { key: 'marketGain', header: 'Market Gain', align: 'right', render: v => <span className={v >= 0 ? 'text-success' : 'text-danger'}>{fmt.currencyFull(v)}</span>, footerRender: v => <span className={v >= 0 ? 'text-success' : 'text-danger'}>{fmt.currencyFull(v)}</span> },
                                { key: 'val2024', header: '2024 Value', align: 'right', render: v => v > 0 ? <span className="font-semibold">{fmt.currencyFull(v)}</span> : <span className="text-gray-400">â€”</span>, footerRender: v => <span className="font-semibold">{fmt.currencyFull(v)}</span> },
                                { key: 'roic', header: 'ROIC', align: 'right', render: (v, r) => { const base = r.val2023 + r.bought + r.reinvested - r.sold; const roic = base > 0 ? (r.marketGain / base) * 100 : 0; return <span className={`font-semibold ${roic >= 0 ? 'text-success' : 'text-danger'}`}>{fmt.percent(roic)}</span>; }, footerRender: v => <span className={`font-semibold ${v >= 0 ? 'text-success' : 'text-danger'}`}>{fmt.percent(v)}</span> },
                              ]}
                              data={computed2024.holdingsAnalysis}
                              footer={{
                                val2023: computed2024.holdingsAnalysis.reduce((s, h) => s + h.val2023, 0),
                                dividends: computed2024.holdingsAnalysis.reduce((s, h) => s + h.dividends, 0),
                                bought: computed2024.holdingsAnalysis.reduce((s, h) => s + h.bought, 0),
                                sold: computed2024.holdingsAnalysis.reduce((s, h) => s + h.sold, 0),
                                reinvested: computed2024.holdingsAnalysis.reduce((s, h) => s + h.reinvested, 0),
                                marketGain: computed2024.holdingsAnalysis.reduce((s, h) => s + h.marketGain, 0),
                                val2024: computed2024.holdingsAnalysis.reduce((s, h) => s + h.val2024, 0),
                                roic: computed2024.marketGainPct
                              }}
                            />
                            <div className="px-5 py-3 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700">
                              <p className="text-xs text-gray-500 dark:text-gray-400">
                                <strong>Formula:</strong> 2023 Value + Bought + Reinvested âˆ’ Sold + Market Gain = 2024 Value Â· <strong>ROIC</strong> = Market Gain / (2023 Value + Bought + Reinvested âˆ’ Sold)
                              </p>
                            </div>
                          </Card>
                        )}

                        {subTab2024 === 'Transactions' && (
                          <Card>
                            <div className="px-5 py-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
                              <div>
                                <h2 className="font-semibold text-gray-900 dark:text-white">2024 Transaction History</h2>
                                <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">{filteredTx2024.length} transactions</p>
                              </div>
                              <select value={txFilter2024} onChange={e => setTxFilter2024(e.target.value)}
                                className="text-sm border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-1.5 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200">
                                {['All', 'Buy', 'Sell', 'Dividend', 'Reinvestment', 'Cash', 'HSA', 'Other'].map(t => <option key={t}>{t}</option>)}
                              </select>
                            </div>
                            <Table
                              maxHeight="500px"
                              columns={[
                                { key: 'date', header: 'Date', mono: true },
                                { key: 'type', header: 'Type', render: v => {
                                  const colors = { Buy: 'accent', Sell: 'danger', Dividend: 'success', Reinvestment: 'success', Cash: 'default', HSA: 'default', Other: 'default' };
                                  return <Badge variant={colors[v] || 'default'}>{v}</Badge>;
                                }},
                                { key: 'symbol', header: 'Symbol', render: v => v || 'â€”' },
                                { key: 'action', header: 'Action', render: v => <span className="text-xs text-gray-500 truncate max-w-64 block">{v}</span> },
                                { key: 'amount', header: 'Amount', align: 'right', render: (v, r) => {
                                  const displayAmt = (r.type === 'Buy' || r.type === 'Reinvestment') ? Math.abs(v) : v;
                                  const isPositive = displayAmt >= 0;
                                  return <span className={isPositive ? 'text-success' : 'text-danger'}>{fmt.currencyFull(displayAmt)}</span>;
                                }, footerRender: v => <span className={v >= 0 ? 'text-success' : 'text-danger'}>{fmt.currencyFull(v)}</span> },
                              ]}
                              data={filteredTx2024}
                              footer={{
                                amount: filteredTx2024.reduce((s, t) => s + ((t.type === 'Buy' || t.type === 'Reinvestment') ? Math.abs(t.amount || 0) : (t.amount || 0)), 0)
                              }}
                            />
                          </Card>
                        )}
                      </div>
                    )}

                    {tab === '2024' && !computed2024 && (
                      <div className="py-12 text-center">
                        <div className="text-4xl mb-3">ğŸ“…</div>
                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-2">2024 Data Not Available</h3>
                        <p className="text-sm text-gray-500 dark:text-gray-400">Import your 2023 year-end holdings and 2024 transactions to see this view.</p>
                      </div>
                    )}
                  </div>
                </Card>
              </>
            )}
          </main>

          {/* Footer */}
          <footer className="border-t border-gray-200 dark:border-gray-800 mt-12">
            <div className="max-w-6xl mx-auto px-6 py-6 text-center text-xs text-gray-400 dark:text-gray-500">
              All data stored locally in your browser. No data is sent to any server.
            </div>
          </footer>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
