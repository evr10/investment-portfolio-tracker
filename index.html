<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Portfolio Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .upload-section {
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .file-input-wrapper {
            display: inline-block;
            margin: 10px;
        }

        .file-input-wrapper label {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
        }

        .file-input-wrapper label:hover {
            background: #5a67d8;
        }

        .file-input-wrapper input {
            display: none;
        }

        .file-name {
            display: block;
            margin-top: 8px;
            color: #4a5568;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
        }

        .stat-change {
            font-size: 14px;
            margin-top: 8px;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .transactions-table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
        }

        .transactions-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
        }

        .transactions-table tr:hover {
            background: #f7fafc;
        }

        .buy {
            color: #38a169;
            font-weight: 600;
        }

        .sell {
            color: #e53e3e;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .account-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .account-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .account-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .account-stat {
            background: white;
            padding: 12px;
            border-radius: 6px;
        }

        .account-stat-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 4px;
        }

        .account-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“ˆ Investment Portfolio Tracker</h1>
        <p class="subtitle">Upload your Fidelity year-end statements and transaction data to visualize your 2025 portfolio performance</p>

        <div class="upload-section">
            <h3 style="margin-bottom: 20px; color: #2d3748;">Upload Your Data</h3>
            
            <div class="file-input-wrapper">
                <label for="pdf2024">
                    ðŸ“„ 2024 Statements (PDF)
                </label>
                <input type="file" id="pdf2024" accept=".pdf" multiple>
                <span class="file-name" id="pdf2024-name">No files chosen</span>
            </div>

            <div class="file-input-wrapper">
                <label for="pdf2025">
                    ðŸ“„ 2025 Statements (PDF)
                </label>
                <input type="file" id="pdf2025" accept=".pdf" multiple>
                <span class="file-name" id="pdf2025-name">No files chosen</span>
            </div>

            <div class="file-input-wrapper">
                <label for="csvTransactions">
                    ðŸ“Š Transaction CSVs (All Quarters)
                </label>
                <input type="file" id="csvTransactions" accept=".csv" multiple>
                <span class="file-name" id="csv-name">No files chosen</span>
            </div>
        </div>

        <div id="error-message"></div>
        <div id="loading" class="loading" style="display: none;">Processing your data...</div>

        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Portfolio Value (2025)</div>
                    <div class="stat-value" id="current-value">$0</div>
                    <div class="stat-change" id="year-change">+$0 (0%)</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Total Purchases</div>
                    <div class="stat-value" id="total-purchases">$0</div>
                    <div class="stat-change" id="purchase-count">0 transactions</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Total Sales</div>
                    <div class="stat-value" id="total-sales">$0</div>
                    <div class="stat-change" id="sale-count">0 transactions</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Net Activity</div>
                    <div class="stat-value" id="net-activity">$0</div>
                    <div class="stat-change" id="activity-type">Invested</div>
                </div>
            </div>

            <div class="chart-container">
                <h2>Portfolio Growth (2024 - 2025)</h2>
                <canvas id="growthChart"></canvas>
            </div>

            <div class="chart-container">
                <h2>Account Performance Breakdown</h2>
                <div id="account-breakdown"></div>
            </div>

            <div class="chart-container">
                <h2>Performance by Holding</h2>
                <canvas id="holdingsChart"></canvas>
            </div>

            <div class="chart-container">
                <h2>Buy/Sell Activity by Symbol</h2>
                <canvas id="symbolActivityChart"></canvas>
            </div>

            <div class="chart-container">
                <h2>Monthly Transaction Activity</h2>
                <canvas id="transactionChart"></canvas>
            </div>

            <div class="chart-container">
                <h2>Transaction History by Account</h2>
                <div style="margin-bottom: 20px;">
                    <label for="account-filter" style="font-weight: 600; margin-right: 10px;">Filter by Account:</label>
                    <select id="account-filter" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #cbd5e0;">
                        <option value="all">All Accounts</option>
                    </select>
                    <label for="symbol-filter" style="font-weight: 600; margin-left: 20px; margin-right: 10px;">Filter by Symbol:</label>
                    <select id="symbol-filter" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #cbd5e0;">
                        <option value="all">All Symbols</option>
                    </select>
                </div>
                <table class="transactions-table" id="transactions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Account</th>
                            <th>Type</th>
                            <th>Symbol</th>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        var portfolioData = {
            value2024: 0,
            value2025: 0,
            transactions: [],
            accounts: {}
        };

        document.getElementById('pdf2024').addEventListener('change', function(e) {
            var files = Array.from(e.target.files);
            document.getElementById('pdf2024-name').textContent = files.length > 0 ? files.length + ' file(s) selected' : 'No files chosen';
            
            files.forEach(function(file) {
                processPDF(file, 2024);
            });
        });

        document.getElementById('pdf2025').addEventListener('change', function(e) {
            var files = Array.from(e.target.files);
            document.getElementById('pdf2025-name').textContent = files.length > 0 ? files.length + ' file(s) selected' : 'No files chosen';
            
            files.forEach(function(file) {
                processPDF(file, 2025);
            });
        });

        document.getElementById('csvTransactions').addEventListener('change', function(e) {
            var files = Array.from(e.target.files);
            document.getElementById('csv-name').textContent = files.length > 0 ? files.length + ' file(s) selected' : 'No files chosen';
            
            files.forEach(function(file) {
                processCSV(file);
            });
        });

        function processPDF(file, year) {
            showLoading(true);
            
            var reader = new FileReader();
            reader.onload = function(e) {
                var arrayBuffer = e.target.result;
                
                pdfjsLib.getDocument({data: arrayBuffer}).promise.then(function(pdf) {
                    var numPages = pdf.numPages;
                    var textPromises = [];
                    
                    for (var i = 1; i <= numPages; i++) {
                        textPromises.push(
                            pdf.getPage(i).then(function(page) {
                                return page.getTextContent().then(function(content) {
                                    return content.items.map(function(item) { return item.str; }).join(' ');
                                });
                            })
                        );
                    }
                    
                    Promise.all(textPromises).then(function(texts) {
                        var text = texts.join(' ');
                        
                        var valueMatch = text.match(/Your\s+Net\s+Portfolio\s+Value[:\s]+\$?([\d,]+\.?\d*)/i);
                        
                        if (!valueMatch) {
                            valueMatch = text.match(/Ending\s+Net\s+Portfolio\s+Value[:\s]+\$?([\d,]+\.?\d*)/i);
                        }
                        
                        if (!valueMatch) {
                            var accountMatches = text.match(/Ending\s+(?:Net\s+)?Account\s+Value[:\s]+\$?([\d,]+\.?\d*)/gi);
                            if (accountMatches && accountMatches.length > 0) {
                                var totalValue = 0;
                                accountMatches.forEach(function(match) {
                                    var val = match.match(/\$?([\d,]+\.?\d*)/);
                                    if (val) {
                                        totalValue += parseFloat(val[1].replace(/,/g, ''));
                                    }
                                });
                                if (totalValue > 0) {
                                    if (year === 2024) {
                                        portfolioData.value2024 += totalValue;
                                    } else {
                                        portfolioData.value2025 += totalValue;
                                    }
                                }
                            }
                        }
                        
                        if (valueMatch) {
                            var value = parseFloat(valueMatch[1].replace(/,/g, ''));
                            if (year === 2024) {
                                portfolioData.value2024 += value;
                            } else {
                                portfolioData.value2025 += value;
                            }
                        }

                        updateDashboard();
                        showLoading(false);
                    });
                }).catch(function(error) {
                    showError('Error processing ' + year + ' PDF (' + file.name + '): ' + error.message);
                    showLoading(false);
                });
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processCSV(file) {
            showLoading(true);
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        var newTransactions = results.data
                            .map(function(row) {
                                var date = row['Run Date'] || row['Date'] || row['Trade Date'] || '';
                                var action = row['Action'] || row['Type'] || row['Transaction Type'] || '';
                                var symbol = row['Symbol'] || row['Ticker'] || '';
                                var description = row['Description'] || row['Security Description'] || '';
                                var quantity = row['Quantity'] || row['Shares'] || '0';
                                var price = row['Price'] || row['Unit Price'] || '0';
                                var amount = row['Amount'] || row['Net Amount'] || '0';
                                var account = row['Account Number'] || row['Account'] || row['Account Name'] || 'Unknown';

                                return {
                                    date: date,
                                    action: action,
                                    symbol: symbol,
                                    description: description,
                                    quantity: parseFloat(quantity.toString().replace(/,/g, '')) || 0,
                                    price: parseFloat(price.toString().replace(/[\$,]/g, '')) || 0,
                                    amount: parseFloat(amount.toString().replace(/[\$,]/g, '')) || 0,
                                    account: account
                                };
                            })
                            .filter(function(t) { return t.date && t.action; });

                        portfolioData.transactions = portfolioData.transactions.concat(newTransactions);
                        
                        var uniqueTransactions = [];
                        var seen = new Set();
                        
                        portfolioData.transactions.forEach(function(t) {
                            var key = t.date + '-' + t.action + '-' + t.symbol + '-' + t.amount + '-' + t.account;
                            if (!seen.has(key)) {
                                seen.add(key);
                                uniqueTransactions.push(t);
                            }
                        });
                        
                        portfolioData.transactions = uniqueTransactions.sort(function(a, b) {
                            return new Date(a.date) - new Date(b.date);
                        });

                        updateDashboard();
                        showLoading(false);
                    } catch (error) {
                        showError('Error processing CSV (' + file.name + '): ' + error.message);
                        showLoading(false);
                    }
                }
            });
        }

        function updateDashboard() {
            if (portfolioData.value2024 === 0 && portfolioData.value2025 === 0 && portfolioData.transactions.length === 0) {
                return;
            }

            document.getElementById('dashboard').style.display = 'block';

            var purchases = portfolioData.transactions.filter(function(t) {
                return t.action.toLowerCase().includes('buy') || t.action.toLowerCase().includes('purchase');
            });
            
            var sales = portfolioData.transactions.filter(function(t) {
                return t.action.toLowerCase().includes('sell') || t.action.toLowerCase().includes('sale');
            });

            var totalPurchases = purchases.reduce(function(sum, t) { return sum + Math.abs(t.amount); }, 0);
            var totalSales = sales.reduce(function(sum, t) { return sum + Math.abs(t.amount); }, 0);
            var netActivity = totalPurchases - totalSales;

            var accounts = {};
            portfolioData.transactions.forEach(function(t) {
                if (!accounts[t.account]) {
                    accounts[t.account] = {
                        purchases: [],
                        sales: [],
                        symbols: new Set()
                    };
                }
                if (t.action.toLowerCase().includes('buy') || t.action.toLowerCase().includes('purchase')) {
                    accounts[t.account].purchases.push(t);
                } else if (t.action.toLowerCase().includes('sell') || t.action.toLowerCase().includes('sale')) {
                    accounts[t.account].sales.push(t);
                }
                if (t.symbol) {
                    accounts[t.account].symbols.add(t.symbol);
                }
            });

            portfolioData.accounts = accounts;

            document.getElementById('current-value').textContent = '$' + portfolioData.value2025.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            var change = portfolioData.value2025 - portfolioData.value2024;
            var changePercent = portfolioData.value2024 > 0 ? ((change / portfolioData.value2024) * 100) : 0;
            document.getElementById('year-change').textContent = (change >= 0 ? '+' : '') + '$' + change.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' (' + changePercent.toFixed(2) + '%)';

            document.getElementById('total-purchases').textContent = '$' + totalPurchases.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('purchase-count').textContent = purchases.length + ' transactions';

            document.getElementById('total-sales').textContent = '$' + totalSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('sale-count').textContent = sales.length + ' transactions';

            document.getElementById('net-activity').textContent = '$' + Math.abs(netActivity).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('activity-type').textContent = netActivity >= 0 ? 'Net Invested' : 'Net Withdrawn';

            createGrowthChart();
            createAccountBreakdown(accounts);
            createHoldingsChart(purchases, sales);
            createSymbolActivityChart(purchases, sales);
            createTransactionChart(purchases, sales);
            createTransactionTable();
            populateFilters();
        }

        function createGrowthChart() {
            var ctx = document.getElementById('growthChart');
            if (window.growthChart) window.growthChart.destroy();

            window.growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['End of 2024', 'End of 2025'],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [portfolioData.value2024, portfolioData.value2025],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createAccountBreakdown(accounts) {
            var container = document.getElementById('account-breakdown');
            container.innerHTML = '';

            Object.keys(accounts).forEach(function(accountName) {
                var acc = accounts[accountName];
                var totalPurchases = acc.purchases.reduce(function(sum, t) { return sum + Math.abs(t.amount); }, 0);
                var totalSales = acc.sales.reduce(function(sum, t) { return sum + Math.abs(t.amount); }, 0);
                var netActivity = totalPurchases - totalSales;

                var card = document.createElement('div');
                card.className = 'account-card';
                
                var h3 = document.createElement('h3');
                h3.textContent = 'Account: ' + accountName;
                card.appendChild(h3);
                
                var statsDiv = document.createElement('div');
                statsDiv.className = 'account-stats';
                
                var purchaseDiv = document.createElement('div');
                purchaseDiv.className = 'account-stat';
                purchaseDiv.innerHTML = '<div class="account-stat-label">Total Purchases</div><div class="account-stat-value" style="color: #38a169;">$' + 
                    totalPurchases.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</div>';
                statsDiv.appendChild(purchaseDiv);
                
                var salesDiv = document.createElement('div');
                salesDiv.className = 'account-stat';
                salesDiv.innerHTML = '<div class="account-stat-label">Total Sales</div><div class="account-stat-value" style="color: #e53e3e;">$' + 
                    totalSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</div>';
                statsDiv.appendChild(salesDiv);
                
                var netDiv = document.createElement('div');
                netDiv.className = 'account-stat';
                netDiv.innerHTML = '<div class="account-stat-label">Net Activity</div><div class="account-stat-value">' + 
                    (netActivity >= 0 ? '+' : '') + '$' + netActivity.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</div>';
                statsDiv.appendChild(netDiv);
                
                var symbolsDiv = document.createElement('div');
                symbolsDiv.className = 'account-stat';
                symbolsDiv.innerHTML = '<div class="account-stat-label">Unique Symbols</div><div class="account-stat-value">' + acc.symbols.size + '</div>';
                statsDiv.appendChild(symbolsDiv);
                
                card.appendChild(statsDiv);
                container.appendChild(card);
            });
        }

        function createHoldingsChart(purchases, sales) {
            var ctx = document.getElementById('holdingsChart');
            if (window.holdingsChart) window.holdingsChart.destroy();

            var symbolData = {};
            
            purchases.forEach(function(t) {
                if (t.symbol) {
                    if (!symbolData[t.symbol]) {
                        symbolData[t.symbol] = { purchases: 0, sales: 0 };
                    }
                    symbolData[t.symbol].purchases += Math.abs(t.amount);
                }
            });

            sales.forEach(function(t) {
                if (t.symbol) {
                    if (!symbolData[t.symbol]) {
                        symbolData[t.symbol] = { purchases: 0, sales: 0 };
                    }
                    symbolData[t.symbol].sales += Math.abs(t.amount);
                }
            });

            var symbols = Object.keys(symbolData)
                .map(function(sym) {
                    return {
                        symbol: sym,
                        purchases: symbolData[sym].purchases,
                        sales: symbolData[sym].sales,
                        total: symbolData[sym].purchases + symbolData[sym].sales
                    };
                })
                .sort(function(a, b) { return b.total - a.total; })
                .slice(0, 15);

            window.holdingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: symbols.map(function(s) { return s.symbol; }),
                    datasets: [{
                        label: 'Purchases',
                        data: symbols.map(function(s) { return s.purchases; }),
                        backgroundColor: 'rgba(56, 161, 105, 0.8)'
                    }, {
                        label: 'Sales',
                        data: symbols.map(function(s) { return s.sales; }),
                        backgroundColor: 'rgba(229, 62, 62, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createSymbolActivityChart(purchases, sales) {
            var ctx = document.getElementById('symbolActivityChart');
            if (window.symbolActivityChart) window.symbolActivityChart.destroy();

            var symbolData = {};
            
            purchases.concat(sales).forEach(function(t) {
                if (t.symbol) {
                    if (!symbolData[t.symbol]) {
                        symbolData[t.symbol] = { purchases: 0, sales: 0, net: 0 };
                    }
                    if (t.action.toLowerCase().includes('buy') || t.action.toLowerCase().includes('purchase')) {
                        symbolData[t.symbol].purchases += Math.abs(t.amount);
                    } else {
                        symbolData[t.symbol].sales += Math.abs(t.amount);
                    }
                }
            });

            Object.keys(symbolData).forEach(function(sym) {
                symbolData[sym].net = symbolData[sym].purchases - symbolData[sym].sales;
            });

            var symbols = Object.keys(symbolData)
                .map(function(sym) {
                    return {
                        symbol: sym,
                        net: symbolData[sym].net
                    };
                })
                .sort(function(a, b) { return b.net - a.net; })
                .slice(0, 15);

            window.symbolActivityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: symbols.map(function(s) { return s.symbol; }),
                    datasets: [{
                        label: 'Net Position (Purchases - Sales)',
                        data: symbols.map(function(s) { return s.net; }),
                        backgroundColor: symbols.map(function(s) {
                            return s.net >= 0 ? 'rgba(56, 161, 105, 0.8)' : 'rgba(229, 62, 62, 0.8)';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    