<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0a0f;
            --bg-card: #12121a;
            --bg-elevated: #1a1a25;
            --border: #2a2a3a;
            --text-primary: #f0f0f5;
            --text-secondary: #9090a0;
            --text-muted: #606070;
            --accent-green: #00d47e;
            --accent-green-dim: rgba(0, 212, 126, 0.15);
            --accent-red: #ff4757;
            --accent-red-dim: rgba(255, 71, 87, 0.15);
            --accent-blue: #4dabf7;
            --accent-blue-dim: rgba(77, 171, 247, 0.15);
            --accent-gold: #ffd43b;
            --accent-gold-dim: rgba(255, 212, 59, 0.15);
            --accent-purple: #9775fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Header */
        header {
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-deep) 100%);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-blue) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 20px;
            height: 20px;
            color: var(--bg-deep);
        }

        h1 {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .privacy-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--accent-green-dim);
            color: var(--accent-green);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .privacy-badge svg {
            width: 14px;
            height: 14px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--accent-green);
            color: var(--bg-deep);
        }

        .btn-primary:hover {
            background: #00f08e;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--accent-red-dim);
            color: var(--accent-red);
            border: 1px solid transparent;
        }

        .btn-danger:hover {
            background: var(--accent-red);
            color: white;
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        /* Main Layout */
        main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Upload Section */
        .upload-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .upload-section.collapsed {
            padding: 1rem 2rem;
        }

        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .upload-section.collapsed .upload-header {
            margin-bottom: 0;
        }

        .upload-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .upload-header h2 svg {
            width: 20px;
            height: 20px;
            color: var(--accent-blue);
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .upload-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .upload-section.collapsed .upload-content {
            display: none;
        }

        .upload-zone {
            background: var(--bg-elevated);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-zone:hover {
            border-color: var(--accent-blue);
            background: var(--accent-blue-dim);
        }

        .upload-zone.dragover {
            border-color: var(--accent-green);
            background: var(--accent-green-dim);
        }

        .upload-zone h3 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .upload-zone p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .upload-zone input {
            display: none;
        }

        .file-list {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-card);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
        }

        .file-item svg {
            width: 14px;
            height: 14px;
            color: var(--accent-green);
        }

        .file-item .remove {
            margin-left: auto;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
        }

        .file-item .remove:hover {
            color: var(--accent-red);
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .stat-change.positive {
            color: var(--accent-green);
            background: var(--accent-green-dim);
        }

        .stat-change.negative {
            color: var(--accent-red);
            background: var(--accent-red-dim);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-card);
            padding: 0.375rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            width: fit-content;
        }

        .tab {
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            font-family: inherit;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        /* Tables */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .table-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
        }

        .search-box svg {
            width: 16px;
            height: 16px;
            color: var(--text-muted);
        }

        .search-box input {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.875rem;
            outline: none;
            width: 200px;
            font-family: inherit;
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem 1.5rem;
            text-align: left;
        }

        th {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
        }

        td {
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: var(--bg-elevated);
        }

        .symbol-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .symbol-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.625rem;
            text-transform: uppercase;
        }

        .symbol-icon.stock { background: var(--accent-blue-dim); color: var(--accent-blue); }
        .symbol-icon.etf { background: var(--accent-purple); color: white; opacity: 0.9; }
        .symbol-icon.mutual { background: var(--accent-gold-dim); color: var(--accent-gold); }
        .symbol-icon.money { background: var(--accent-green-dim); color: var(--accent-green); }
        .symbol-icon.other { background: var(--bg-elevated); color: var(--text-secondary); }

        .symbol-info strong {
            display: block;
            font-weight: 600;
        }

        .symbol-info span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .value-positive { color: var(--accent-green); }
        .value-negative { color: var(--accent-red); }

        .text-right { text-align: right; }
        .text-muted { color: var(--text-secondary); }

        /* Empty State */
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            max-width: 400px;
            margin: 0 auto;
        }

        /* Account Cards */
        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .account-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .account-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .account-card.selected {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--accent-green-dim) 100%);
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .account-name {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .account-number {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .account-value {
            text-align: right;
        }

        .account-value strong {
            display: block;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .account-change {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            justify-content: flex-end;
        }

        .account-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .breakdown-item {
            text-align: center;
        }

        .breakdown-label {
            font-size: 0.625rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .breakdown-value {
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        /* Transactions Tab */
        .transaction-type {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .transaction-type.buy { background: var(--accent-green-dim); color: var(--accent-green); }
        .transaction-type.sell { background: var(--accent-red-dim); color: var(--accent-red); }
        .transaction-type.dividend { background: var(--accent-gold-dim); color: var(--accent-gold); }
        .transaction-type.reinvest { background: var(--accent-blue-dim); color: var(--accent-blue); }
        .transaction-type.transfer { background: var(--bg-elevated); color: var(--text-secondary); }
        .transaction-type.other { background: var(--bg-elevated); color: var(--text-muted); }

        /* Filter Pills */
        .filter-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-pill {
            padding: 0.375rem 0.875rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-pill:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .filter-pill.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: var(--bg-deep);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-deep);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            main {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            th, td {
                padding: 0.75rem 1rem;
            }

            .accounts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        .toast.success { border-color: var(--accent-green); }
        .toast.error { border-color: var(--accent-red); }

        .toast svg {
            width: 20px;
            height: 20px;
        }

        .toast.success svg { color: var(--accent-green); }
        .toast.error svg { color: var(--accent-red); }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 1rem;
        }

        .progress-bar {
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-green);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* Detail Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--bg-card);
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
        }

        .modal-close:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .holding-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .holding-detail-item {
            background: var(--bg-elevated);
            padding: 1rem;
            border-radius: 8px;
        }

        .holding-detail-label {
            font-size: 0.625rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .holding-detail-value {
            font-size: 1rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <h1>Portfolio Tracker</h1>
            </div>
            <div class="header-actions">
                <div class="privacy-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0110 0v4"/>
                    </svg>
                    Local Storage Only
                </div>
                <button class="btn btn-secondary" onclick="exportData()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                </button>
                <button class="btn btn-danger" onclick="clearAllData()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                    Clear Data
                </button>
            </div>
        </div>
    </header>

    <main>
        <!-- Upload Section -->
        <section class="upload-section" id="uploadSection">
            <div class="upload-header">
                <h2>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Import Data
                </h2>
                <button class="toggle-btn" onclick="toggleUpload()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </button>
            </div>
            <div class="upload-content">
                <div class="upload-zone" id="holdingsZone2024">
                    <h3>2024 Year-End Holdings</h3>
                    <p>Drop CSV file or click to browse</p>
                    <input type="file" accept=".csv" onchange="handleFile(event, 'holdings2024')">
                    <div class="file-list" id="holdings2024List"></div>
                </div>
                <div class="upload-zone" id="holdingsZone2025">
                    <h3>2025 Year-End Holdings</h3>
                    <p>Drop CSV file or click to browse</p>
                    <input type="file" accept=".csv" onchange="handleFile(event, 'holdings2025')">
                    <div class="file-list" id="holdings2025List"></div>
                </div>
                <div class="upload-zone" id="transactionsZone">
                    <h3>2025 Transactions (Q1-Q4)</h3>
                    <p>Drop CSV files or click to browse (multiple allowed)</p>
                    <input type="file" accept=".csv" multiple onchange="handleFile(event, 'transactions')">
                    <div class="file-list" id="transactionsList"></div>
                </div>
            </div>
            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <p class="progress-text" id="progressText">Processing...</p>
            </div>
        </section>

        <!-- Stats Overview -->
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-label">Total Portfolio Value</div>
                <div class="stat-value mono" id="statTotalValue">$0</div>
                <div class="stat-change positive" id="statTotalChange">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                        <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    +0%
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">YTD Growth</div>
                <div class="stat-value mono" id="statYTDGrowth">$0</div>
                <div class="stat-change" id="statYTDChange">From Dec 2024</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Unrealized Gain/Loss</div>
                <div class="stat-value mono" id="statUnrealized">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Cost Basis</div>
                <div class="stat-value mono" id="statCostBasis">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">2025 Purchases</div>
                <div class="stat-value mono" id="statPurchases">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">2025 Sales</div>
                <div class="stat-value mono" id="statSales">$0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs" id="mainTabs" style="display: none;">
            <button class="tab active" data-tab="accounts">By Account</button>
            <button class="tab" data-tab="holdings">All Holdings</button>
            <button class="tab" data-tab="transactions">Transactions</button>
        </div>

        <!-- Accounts View -->
        <div id="accountsView">
            <div class="accounts-grid" id="accountsGrid"></div>
            <div class="table-container" id="accountHoldingsTable" style="display: none;">
                <div class="table-header">
                    <h3 id="accountHoldingsTitle">Holdings</h3>
                    <button class="btn btn-secondary" onclick="clearAccountSelection()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                        Clear Selection
                    </button>
                </div>
                <div class="table-scroll" style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th class="text-right">Quantity</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Market Value</th>
                                <th class="text-right">Cost Basis</th>
                                <th class="text-right">Gain/Loss</th>
                                <th class="text-right">YTD Change</th>
                            </tr>
                        </thead>
                        <tbody id="accountHoldingsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Holdings View -->
        <div id="holdingsView" style="display: none;">
            <div class="filter-row">
                <button class="filter-pill active" data-filter="all">All</button>
                <button class="filter-pill" data-filter="Stock">Stocks</button>
                <button class="filter-pill" data-filter="ETF">ETFs</button>
                <button class="filter-pill" data-filter="Mutual Fund">Mutual Funds</button>
                <button class="filter-pill" data-filter="other">Other</button>
            </div>
            <div class="table-container">
                <div class="table-header">
                    <h3>All Holdings</h3>
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        <input type="text" placeholder="Search holdings..." id="holdingsSearch">
                    </div>
                </div>
                <div class="table-scroll" style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Account</th>
                                <th class="text-right">Quantity</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Market Value</th>
                                <th class="text-right">Cost Basis</th>
                                <th class="text-right">Gain/Loss</th>
                                <th class="text-right">YTD Change</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transactions View -->
        <div id="transactionsView" style="display: none;">
            <div class="filter-row">
                <button class="filter-pill active" data-txfilter="all">All</button>
                <button class="filter-pill" data-txfilter="buy">Purchases</button>
                <button class="filter-pill" data-txfilter="sell">Sales</button>
                <button class="filter-pill" data-txfilter="dividend">Dividends</button>
                <button class="filter-pill" data-txfilter="reinvest">Reinvestments</button>
            </div>
            <div class="table-container">
                <div class="table-header">
                    <h3>2025 Transactions</h3>
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        <input type="text" placeholder="Search transactions..." id="transactionsSearch">
                    </div>
                </div>
                <div class="table-scroll" style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Symbol</th>
                                <th>Account</th>
                                <th class="text-right">Quantity</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/>
                <polyline points="13 2 13 9 20 9"/>
            </svg>
            <h3>No Portfolio Data</h3>
            <p>Upload your Fidelity CSV files to see your portfolio overview. Your data stays in your browser and is never sent to any server.</p>
        </div>
    </main>

    <!-- Holding Detail Modal -->
    <div class="modal-overlay" id="holdingModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Holding Details</h2>
                <button class="modal-close" onclick="closeModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // IndexedDB Setup
        const DB_NAME = 'PortfolioTrackerDB';
        const DB_VERSION = 1;
        let db;

        // Data stores
        let holdings2024 = [];
        let holdings2025 = [];
        let transactions = [];
        let selectedAccount = null;
        let currentFilter = 'all';
        let currentTxFilter = 'all';

        // Initialize IndexedDB
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('holdings2024')) {
                        db.createObjectStore('holdings2024', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('holdings2025')) {
                        db.createObjectStore('holdings2025', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('transactions')) {
                        db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('metadata')) {
                        db.createObjectStore('metadata', { keyPath: 'key' });
                    }
                };
            });
        }

        // Save data to IndexedDB
        async function saveToStore(storeName, data) {
            const transaction = db.transaction(storeName, 'readwrite');
            const store = transaction.objectStore(storeName);
            
            // Clear existing data
            await new Promise((resolve, reject) => {
                const clearRequest = store.clear();
                clearRequest.onsuccess = resolve;
                clearRequest.onerror = reject;
            });
            
            // Add new data
            for (const item of data) {
                store.add(item);
            }
            
            return new Promise((resolve, reject) => {
                transaction.oncomplete = resolve;
                transaction.onerror = reject;
            });
        }

        // Load data from IndexedDB
        async function loadFromStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Parse CSV
        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = [];
            const data = [];
            let headerFound = false;
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                // Skip disclaimer lines
                if (line.startsWith('"The data') || 
                    line.startsWith('"informational') || 
                    line.startsWith('"exported') ||
                    line.startsWith('"purposes') ||
                    line.startsWith('"Brokerage') ||
                    line.startsWith('"Financial') ||
                    line.startsWith('"Fidelity') ||
                    line.startsWith('Date downloaded')) {
                    continue;
                }
                
                // Parse line respecting quotes
                const values = parseCSVLine(line);
                
                if (!headerFound && values.length > 0) {
                    // Find the header row
                    if (values[0] === 'Account_Number' || values[0] === 'Run Date') {
                        headers.push(...values);
                        headerFound = true;
                        continue;
                    }
                }
                
                if (headerFound && values.length >= headers.length - 2) {
                    const row = {};
                    headers.forEach((header, i) => {
                        row[header] = values[i] || '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            
            return values;
        }

        // Parse Holdings CSV
        function parseHoldingsCSV(text) {
            const data = parseCSV(text);
            return data.map(row => ({
                accountNumber: row.Account_Number || '',
                assetClass: row.Asset_Class || '',
                symbol: row.Symbol || '',
                description: row.Description || '',
                quantity: parseFloat(row.Quantity) || 0,
                price: parseFloat(row.Price) || 0,
                marketValue: parseFloat(row.Market_Value) || 0,
                costBasis: parseFloat(row.Cost_Basis) || 0,
                unrealizedGainLoss: parseFloat(row.Unrealized_Gain_Loss) || 0
            })).filter(h => h.symbol && h.accountNumber);
        }

        // Parse Transactions CSV
        function parseTransactionsCSV(text) {
            const data = parseCSV(text);
            return data.map(row => {
                const action = row.Action || '';
                let type = 'other';
                
                if (action.includes('YOU BOUGHT') || action.includes('ESPP')) type = 'buy';
                else if (action.includes('YOU SOLD')) type = 'sell';
                else if (action.includes('DIVIDEND RECEIVED')) type = 'dividend';
                else if (action.includes('REINVESTMENT')) type = 'reinvest';
                else if (action.includes('WIRE TRANSFER') || action.includes('TRANSFER')) type = 'transfer';
                else if (action.includes('CONVERSION')) type = 'conversion';
                else if (action.includes('MARGIN INTEREST')) type = 'interest';
                
                return {
                    date: row['Run Date'] || '',
                    account: row.Account || '',
                    accountNumber: (row['Account Number'] || '').replace(/[^A-Z0-9]/g, ''),
                    action: action,
                    symbol: row.Symbol || '',
                    description: row.Description || '',
                    type: type,
                    quantity: parseFloat(row.Quantity) || 0,
                    price: parseFloat(row.Price) || 0,
                    amount: parseFloat(row.Amount) || 0
                };
            }).filter(t => t.date && t.accountNumber);
        }

        // File handling
        function handleFile(event, type) {
            const files = event.target.files;
            if (!files.length) return;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    
                    if (type === 'holdings2024') {
                        holdings2024 = parseHoldingsCSV(text);
                        await saveToStore('holdings2024', holdings2024);
                        updateFileList('holdings2024List', [file.name]);
                        showToast('2024 holdings imported', 'success');
                    } else if (type === 'holdings2025') {
                        holdings2025 = parseHoldingsCSV(text);
                        await saveToStore('holdings2025', holdings2025);
                        updateFileList('holdings2025List', [file.name]);
                        showToast('2025 holdings imported', 'success');
                    } else if (type === 'transactions') {
                        const newTx = parseTransactionsCSV(text);
                        transactions = [...transactions, ...newTx];
                        // Remove duplicates
                        const seen = new Set();
                        transactions = transactions.filter(t => {
                            const key = `${t.date}-${t.accountNumber}-${t.action}-${t.symbol}-${t.amount}`;
                            if (seen.has(key)) return false;
                            seen.add(key);
                            return true;
                        });
                        await saveToStore('transactions', transactions);
                        updateTransactionsList();
                        showToast(`${newTx.length} transactions imported`, 'success');
                    }
                    
                    updateUI();
                };
                reader.readAsText(file);
            });
        }

        function updateFileList(listId, files) {
            const list = document.getElementById(listId);
            list.innerHTML = files.map(f => `
                <div class="file-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    ${f}
                </div>
            `).join('');
        }

        function updateTransactionsList() {
            const quarters = new Set();
            transactions.forEach(t => {
                const date = new Date(t.date);
                const q = Math.ceil((date.getMonth() + 1) / 3);
                quarters.add(`Q${q} 2025`);
            });
            const list = document.getElementById('transactionsList');
            list.innerHTML = Array.from(quarters).sort().map(q => `
                <div class="file-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    ${q} Transactions
                </div>
            `).join('');
        }

        // Setup drag and drop
        function setupDragDrop() {
            const zones = document.querySelectorAll('.upload-zone');
            zones.forEach(zone => {
                zone.addEventListener('click', () => zone.querySelector('input').click());
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('dragover');
                });
                zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('dragover');
                    const input = zone.querySelector('input');
                    input.files = e.dataTransfer.files;
                    input.dispatchEvent(new Event('change'));
                });
            });
        }

        // UI Updates
        function updateUI() {
            const hasData = holdings2025.length > 0;
            
            document.getElementById('emptyState').style.display = hasData ? 'none' : 'block';
            document.getElementById('statsGrid').style.display = hasData ? 'grid' : 'none';
            document.getElementById('mainTabs').style.display = hasData ? 'flex' : 'none';
            
            if (hasData) {
                updateStats();
                updateAccountsView();
                updateHoldingsView();
                updateTransactionsView();
            }
        }

        function updateStats() {
            // Calculate totals from 2025 holdings
            const total2025 = holdings2025.reduce((sum, h) => sum + h.marketValue, 0);
            const total2024 = holdings2024.reduce((sum, h) => sum + h.marketValue, 0);
            const totalCostBasis = holdings2025.reduce((sum, h) => sum + (h.costBasis || 0), 0);
            const totalUnrealized = holdings2025.reduce((sum, h) => sum + (h.unrealizedGainLoss || 0), 0);
            
            // Calculate YTD change
            const ytdGrowth = total2025 - total2024;
            const ytdPercent = total2024 > 0 ? ((ytdGrowth / total2024) * 100) : 0;
            
            // Calculate purchases and sales from transactions
            const purchases = transactions
                .filter(t => t.type === 'buy')
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const sales = transactions
                .filter(t => t.type === 'sell')
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            
            document.getElementById('statTotalValue').textContent = formatCurrency(total2025);
            document.getElementById('statYTDGrowth').textContent = formatCurrency(ytdGrowth);
            document.getElementById('statUnrealized').textContent = formatCurrency(totalUnrealized);
            document.getElementById('statUnrealized').className = `stat-value mono ${totalUnrealized >= 0 ? 'value-positive' : 'value-negative'}`;
            document.getElementById('statCostBasis').textContent = formatCurrency(totalCostBasis);
            document.getElementById('statPurchases').textContent = formatCurrency(purchases);
            document.getElementById('statSales').textContent = formatCurrency(sales);
            
            const changeEl = document.getElementById('statTotalChange');
            changeEl.className = `stat-change ${ytdGrowth >= 0 ? 'positive' : 'negative'}`;
            changeEl.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                    <polyline points="${ytdGrowth >= 0 ? '18 15 12 9 6 15' : '6 9 12 15 18 9'}"/>
                </svg>
                ${ytdGrowth >= 0 ? '+' : ''}${ytdPercent.toFixed(2)}%
            `;
            
            const ytdChangeEl = document.getElementById('statYTDChange');
            ytdChangeEl.className = `stat-change ${ytdGrowth >= 0 ? 'positive' : 'negative'}`;
            ytdChangeEl.textContent = `${ytdGrowth >= 0 ? '+' : ''}${formatCurrency(ytdGrowth)} from Dec 2024`;
        }

        function updateAccountsView() {
            const accounts = {};
            
            // Group 2025 holdings by account
            holdings2025.forEach(h => {
                if (!accounts[h.accountNumber]) {
                    accounts[h.accountNumber] = {
                        number: h.accountNumber,
                        holdings: [],
                        marketValue: 0,
                        costBasis: 0,
                        unrealized: 0,
                        value2024: 0
                    };
                }
                accounts[h.accountNumber].holdings.push(h);
                accounts[h.accountNumber].marketValue += h.marketValue;
                accounts[h.accountNumber].costBasis += h.costBasis || 0;
                accounts[h.accountNumber].unrealized += h.unrealizedGainLoss || 0;
            });
            
            // Add 2024 values
            holdings2024.forEach(h => {
                if (accounts[h.accountNumber]) {
                    accounts[h.accountNumber].value2024 += h.marketValue;
                }
            });
            
            // Get account names from transactions
            const accountNames = {};
            transactions.forEach(t => {
                if (t.account && t.accountNumber) {
                    accountNames[t.accountNumber] = t.account;
                }
            });
            
            const grid = document.getElementById('accountsGrid');
            grid.innerHTML = Object.values(accounts).map(acc => {
                const ytdChange = acc.marketValue - acc.value2024;
                const ytdPercent = acc.value2024 > 0 ? ((ytdChange / acc.value2024) * 100) : 0;
                const name = accountNames[acc.number] || 'Brokerage Account';
                
                return `
                    <div class="account-card ${selectedAccount === acc.number ? 'selected' : ''}" 
                         onclick="selectAccount('${acc.number}')">
                        <div class="account-header">
                            <div>
                                <div class="account-name">${name}</div>
                                <div class="account-number">${formatAccountNumber(acc.number)}</div>
                            </div>
                            <div class="account-value">
                                <strong>${formatCurrency(acc.marketValue)}</strong>
                                <div class="account-change ${ytdChange >= 0 ? 'value-positive' : 'value-negative'}">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                        <polyline points="${ytdChange >= 0 ? '18 15 12 9 6 15' : '6 9 12 15 18 9'}"/>
                                    </svg>
                                    ${ytdChange >= 0 ? '+' : ''}${ytdPercent.toFixed(1)}%
                                </div>
                            </div>
                        </div>
                        <div class="account-breakdown">
                            <div class="breakdown-item">
                                <div class="breakdown-label">Holdings</div>
                                <div class="breakdown-value">${acc.holdings.length}</div>
                            </div>
                            <div class="breakdown-item">
                                <div class="breakdown-label">Cost Basis</div>
                                <div class="breakdown-value">${formatCurrency(acc.costBasis)}</div>
                            </div>
                            <div class="breakdown-item">
                                <div class="breakdown-label">Unrealized</div>
                                <div class="breakdown-value ${acc.unrealized >= 0 ? 'value-positive' : 'value-negative'}">
                                    ${formatCurrency(acc.unrealized)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectAccount(accountNumber) {
            selectedAccount = selectedAccount === accountNumber ? null : accountNumber;
            updateAccountsView();
            
            const table = document.getElementById('accountHoldingsTable');
            if (selectedAccount) {
                const holdings = holdings2025.filter(h => h.accountNumber === selectedAccount);
                const holdings2024Map = {};
                holdings2024.filter(h => h.accountNumber === selectedAccount)
                    .forEach(h => holdings2024Map[h.symbol] = h);
                
                document.getElementById('accountHoldingsTitle').textContent = 
                    `Holdings - ${formatAccountNumber(selectedAccount)}`;
                
                const tbody = document.getElementById('accountHoldingsBody');
                tbody.innerHTML = holdings.map(h => {
                    const prev = holdings2024Map[h.symbol];
                    const ytdChange = prev ? h.marketValue - prev.marketValue : h.marketValue;
                    const ytdPercent = prev && prev.marketValue > 0 
                        ? ((ytdChange / prev.marketValue) * 100) : 0;
                    
                    return renderHoldingRow(h, ytdChange, ytdPercent, false);
                }).join('');
                
                table.style.display = 'block';
            } else {
                table.style.display = 'none';
            }
        }

        function clearAccountSelection() {
            selectedAccount = null;
            updateAccountsView();
            document.getElementById('accountHoldingsTable').style.display = 'none';
        }

        function updateHoldingsView() {
            const holdings2024Map = {};
            holdings2024.forEach(h => {
                const key = `${h.accountNumber}-${h.symbol}`;
                holdings2024Map[key] = h;
            });
            
            const accountNames = {};
            transactions.forEach(t => {
                if (t.account && t.accountNumber) {
                    accountNames[t.accountNumber] = t.account;
                }
            });
            
            let filtered = holdings2025;
            if (currentFilter !== 'all') {
                if (currentFilter === 'other') {
                    filtered = holdings2025.filter(h => 
                        !['Stock', 'ETF', 'Mutual Fund'].includes(h.assetClass));
                } else {
                    filtered = holdings2025.filter(h => h.assetClass === currentFilter);
                }
            }
            
            const searchTerm = document.getElementById('holdingsSearch')?.value?.toLowerCase() || '';
            if (searchTerm) {
                filtered = filtered.filter(h => 
                    h.symbol.toLowerCase().includes(searchTerm) ||
                    h.description.toLowerCase().includes(searchTerm));
            }
            
            const tbody = document.getElementById('holdingsBody');
            tbody.innerHTML = filtered.map(h => {
                const key = `${h.accountNumber}-${h.symbol}`;
                const prev = holdings2024Map[key];
                const ytdChange = prev ? h.marketValue - prev.marketValue : h.marketValue;
                const ytdPercent = prev && prev.marketValue > 0 
                    ? ((ytdChange / prev.marketValue) * 100) : 0;
                const accountName = accountNames[h.accountNumber] || h.accountNumber;
                
                return renderHoldingRow(h, ytdChange, ytdPercent, true, accountName);
            }).join('');
        }

        function renderHoldingRow(h, ytdChange, ytdPercent, showAccount, accountName = '') {
            const iconClass = getAssetIconClass(h.assetClass);
            const initials = h.symbol.substring(0, 2);
            
            return `
                <tr onclick="showHoldingDetail('${h.symbol}', '${h.accountNumber}')" style="cursor: pointer;">
                    <td>
                        <div class="symbol-cell">
                            <div class="symbol-icon ${iconClass}">${initials}</div>
                            <div class="symbol-info">
                                <strong>${h.symbol}</strong>
                                <span>${truncate(h.description, 30)}</span>
                            </div>
                        </div>
                    </td>
                    ${showAccount ? `<td class="text-muted">${truncate(accountName, 20)}</td>` : ''}
                    <td class="text-right mono">${formatNumber(h.quantity)}</td>
                    <td class="text-right mono">${formatCurrency(h.price)}</td>
                    <td class="text-right mono">${formatCurrency(h.marketValue)}</td>
                    <td class="text-right mono">${h.costBasis ? formatCurrency(h.costBasis) : '-'}</td>
                    <td class="text-right mono ${h.unrealizedGainLoss >= 0 ? 'value-positive' : 'value-negative'}">
                        ${h.unrealizedGainLoss ? formatCurrency(h.unrealizedGainLoss) : '-'}
                    </td>
                    <td class="text-right">
                        <span class="stat-change ${ytdChange >= 0 ? 'positive' : 'negative'}">
                            ${ytdChange >= 0 ? '+' : ''}${ytdPercent.toFixed(1)}%
                        </span>
                    </td>
                </tr>
            `;
        }

        function updateTransactionsView() {
            let filtered = [...transactions];
            
            if (currentTxFilter !== 'all') {
                filtered = filtered.filter(t => t.type === currentTxFilter);
            }
            
            const searchTerm = document.getElementById('transactionsSearch')?.value?.toLowerCase() || '';
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    t.symbol?.toLowerCase().includes(searchTerm) ||
                    t.description?.toLowerCase().includes(searchTerm) ||
                    t.action?.toLowerCase().includes(searchTerm));
            }
            
            // Sort by date descending
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = filtered.slice(0, 200).map(t => `
                <tr>
                    <td class="mono">${formatDate(t.date)}</td>
                    <td><span class="transaction-type ${t.type}">${t.type}</span></td>
                    <td><strong>${t.symbol || '-'}</strong></td>
                    <td class="text-muted">${truncate(t.account, 20)}</td>
                    <td class="text-right mono">${t.quantity ? formatNumber(t.quantity) : '-'}</td>
                    <td class="text-right mono">${t.price ? formatCurrency(t.price) : '-'}</td>
                    <td class="text-right mono ${t.amount >= 0 ? 'value-positive' : 'value-negative'}">
                        ${formatCurrency(t.amount)}
                    </td>
                </tr>
            `).join('');
        }

        function showHoldingDetail(symbol, accountNumber) {
            const holding = holdings2025.find(h => h.symbol === symbol && h.accountNumber === accountNumber);
            const prevHolding = holdings2024.find(h => h.symbol === symbol && h.accountNumber === accountNumber);
            
            if (!holding) return;
            
            const relatedTx = transactions.filter(t => 
                t.symbol === symbol && t.accountNumber === accountNumber);
            
            const ytdChange = prevHolding ? holding.marketValue - prevHolding.marketValue : holding.marketValue;
            const ytdPercent = prevHolding && prevHolding.marketValue > 0 
                ? ((ytdChange / prevHolding.marketValue) * 100) : 0;
            
            document.getElementById('modalTitle').textContent = `${symbol} - ${holding.description}`;
            document.getElementById('modalBody').innerHTML = `
                <div class="holding-detail-grid">
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">Quantity</div>
                        <div class="holding-detail-value mono">${formatNumber(holding.quantity)}</div>
                    </div>
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">Current Price</div>
                        <div class="holding-detail-value mono">${formatCurrency(holding.price)}</div>
                    </div>
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">Market Value</div>
                        <div class="holding-detail-value mono">${formatCurrency(holding.marketValue)}</div>
                    </div>
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">Cost Basis</div>
                        <div class="holding-detail-value mono">${holding.costBasis ? formatCurrency(holding.costBasis) : 'N/A'}</div>
                    </div>
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">Unrealized G/L</div>
                        <div class="holding-detail-value mono ${holding.unrealizedGainLoss >= 0 ? 'value-positive' : 'value-negative'}">
                            ${holding.unrealizedGainLoss ? formatCurrency(holding.unrealizedGainLoss) : 'N/A'}
                        </div>
                    </div>
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">YTD Change</div>
                        <div class="holding-detail-value ${ytdChange >= 0 ? 'value-positive' : 'value-negative'}">
                            ${ytdChange >= 0 ? '+' : ''}${ytdPercent.toFixed(2)}%
                        </div>
                    </div>
                </div>
                
                ${prevHolding ? `
                <h4 style="margin: 1.5rem 0 1rem; font-size: 0.875rem;">Year-over-Year Comparison</h4>
                <div class="holding-detail-grid">
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">2024 Quantity</div>
                        <div class="holding-detail-value mono">${formatNumber(prevHolding.quantity)}</div>
                    </div>
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">2024 Price</div>
                        <div class="holding-detail-value mono">${formatCurrency(prevHolding.price)}</div>
                    </div>
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">2024 Value</div>
                        <div class="holding-detail-value mono">${formatCurrency(prevHolding.marketValue)}</div>
                    </div>
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">Qty Change</div>
                        <div class="holding-detail-value mono">${formatNumber(holding.quantity - prevHolding.quantity)}</div>
                    </div>
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">Price Change</div>
                        <div class="holding-detail-value mono ${holding.price - prevHolding.price >= 0 ? 'value-positive' : 'value-negative'}">
                            ${formatCurrency(holding.price - prevHolding.price)}
                        </div>
                    </div>
                    <div class="holding-detail-item">
                        <div class="holding-detail-label">Value Change</div>
                        <div class="holding-detail-value mono ${ytdChange >= 0 ? 'value-positive' : 'value-negative'}">
                            ${formatCurrency(ytdChange)}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${relatedTx.length > 0 ? `
                <h4 style="margin: 1.5rem 0 1rem; font-size: 0.875rem;">2025 Transactions (${relatedTx.length})</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    <table style="font-size: 0.75rem;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${relatedTx.sort((a, b) => new Date(b.date) - new Date(a.date))
                                .slice(0, 20)
                                .map(t => `
                                <tr>
                                    <td class="mono">${formatDate(t.date)}</td>
                                    <td><span class="transaction-type ${t.type}">${t.type}</span></td>
                                    <td class="text-right mono">${t.quantity ? formatNumber(t.quantity) : '-'}</td>
                                    <td class="text-right mono ${t.amount >= 0 ? 'value-positive' : 'value-negative'}">
                                        ${formatCurrency(t.amount)}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
            `;
            
            document.getElementById('holdingModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('holdingModal').classList.remove('active');
        }

        // Utility functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value || 0);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 3
            }).format(value || 0);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatAccountNumber(num) {
            if (!num) return '';
            // Format as XXX-XXXXXX
            if (num.length > 3) {
                return num.substring(0, 3) + '-' + num.substring(3);
            }
            return num;
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function getAssetIconClass(assetClass) {
            switch (assetClass) {
                case 'Stock': return 'stock';
                case 'ETF': return 'etf';
                case 'Mutual Fund': return 'mutual';
                case 'Money Market': return 'money';
                default: return 'other';
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${type === 'success' 
                        ? '<polyline points="20 6 9 17 4 12"/>' 
                        : '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'}
                </svg>
                ${message}
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleUpload() {
            document.getElementById('uploadSection').classList.toggle('collapsed');
        }

        async function exportData() {
            const data = {
                holdings2024,
                holdings2025,
                transactions,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully', 'success');
        }

        async function clearAllData() {
            if (!confirm('Are you sure you want to clear all portfolio data? This cannot be undone.')) {
                return;
            }
            
            holdings2024 = [];
            holdings2025 = [];
            transactions = [];
            
            await saveToStore('holdings2024', []);
            await saveToStore('holdings2025', []);
            await saveToStore('transactions', []);
            
            document.getElementById('holdings2024List').innerHTML = '';
            document.getElementById('holdings2025List').innerHTML = '';
            document.getElementById('transactionsList').innerHTML = '';
            
            updateUI();
            showToast('All data cleared', 'success');
        }

        // Tab handling
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tabName = tab.dataset.tab;
                document.getElementById('accountsView').style.display = tabName === 'accounts' ? 'block' : 'none';
                document.getElementById('holdingsView').style.display = tabName === 'holdings' ? 'block' : 'none';
                document.getElementById('transactionsView').style.display = tabName === 'transactions' ? 'block' : 'none';
            });
        });

        // Filter handling
        document.querySelectorAll('.filter-pill[data-filter]').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('.filter-pill[data-filter]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                currentFilter = pill.dataset.filter;
                updateHoldingsView();
            });
        });

        document.querySelectorAll('.filter-pill[data-txfilter]').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('.filter-pill[data-txfilter]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                currentTxFilter = pill.dataset.txfilter;
                updateTransactionsView();
            });
        });

        // Search handling
        document.getElementById('holdingsSearch')?.addEventListener('input', updateHoldingsView);
        document.getElementById('transactionsSearch')?.addEventListener('input', updateTransactionsView);

        // Close modal on overlay click
        document.getElementById('holdingModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });

        // Escape to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Initialize
        async function init() {
            await initDB();
            
            // Load existing data
            holdings2024 = await loadFromStore('holdings2024');
            holdings2025 = await loadFromStore('holdings2025');
            transactions = await loadFromStore('transactions');
            
            // Update file lists if data exists
            if (holdings2024.length > 0) {
                updateFileList('holdings2024List', ['2024 Holdings (cached)']);
            }
            if (holdings2025.length > 0) {
                updateFileList('holdings2025List', ['2025 Holdings (cached)']);
            }
            if (transactions.length > 0) {
                updateTransactionsList();
            }
            
            setupDragDrop();
            updateUI();
            
            // Collapse upload section if we have data
            if (holdings2025.length > 0) {
                document.getElementById('uploadSection').classList.add('collapsed');
            }
        }

        init();
    </script>
</body>
</html>
